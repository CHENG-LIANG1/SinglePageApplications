<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fluent Habit Hub - Analytics Final</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Segoe UI Variable"', '"Segoe UI"', 'sans-serif'],
                    },
                    colors: {
                        fluent: {
                            bg: "#f0f2f5",
                            blue: "#0078D4", 
                            blueHover: "#106EBE",
                            text: "#201F1E",
                            subtext: "#605E5C",
                            danger: "#C50F1F"
                        }
                    },
                    boxShadow: {
                        'card': '0 4px 12px rgba(0,0,0,0.05), 0 0 2px rgba(0,0,0,0.1)',
                        'card-hover': '0 8px 24px rgba(0,0,0,0.08), 0 0 2px rgba(0,0,0,0.1)',
                    },
                    animation: {
                        'pop-fast': 'scaleIn 0.1s cubic-bezier(0, 0, 0.2, 1) forwards',
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                    },
                    keyframes: {
                        scaleIn: {
                            '0%': { transform: 'scale(0.95)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f0f2f5; color: #201F1E; user-select: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #e0e0e0; border-radius: 3px; }
        
        /* Tooltip Logic Fixed */
        .tooltip-container {
            position: relative;
        }
        .tooltip-container:hover .tooltip-content {
            opacity: 1;
            transform: translate(-50%, -10px);
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- 1. Icons Path Data ---
        const ICON_PATHS = {
            activity: "M22 12h-4l-3 9L9 3l-3 9H2",
            book: "M4 19.5A2.5 2.5 0 0 1 6.5 17H20 M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z",
            code: "M16 18l6-6-6-6 M8 6l-6 6 6 6",
            coffee: "M18 8h1a4 4 0 0 1 0 8h-1 M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z M6 1v3 M10 1v3 M14 1v3",
            dumbbell: "M6.5 6.5l11 11 M21 21l-1-1 M3 3l1 1 M18 22l4-4 M2 6l4-4 M3 10l7.5-7.5 M13.5 21L21 13.5",
            music: "M9 18V5l12-2v13 M9 9l12-2 M6 18a3 3 0 1 0 6 0 3 3 0 0 0-6 0z M18 16a3 3 0 1 0 6 0 3 3 0 0 0-6 0z",
            sun: "M12 2v2 M12 20v2 M4.93 4.93l1.41 1.41 M17.66 17.66l1.41 1.41 M2 12h2 M20 12h2 M6.34 17.66l-1.41 1.41 M19.07 4.93l-1.41 1.41 M12 7a5 5 0 1 0 0 10 5 5 0 0 0 0-10z",
            moon: "M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9z",
            zap: "M13 2L3 14h9l-1 8 10-12h-9l1-8z",
            droplet: "M12 2.69l5.74 5.82a7 7 0 0 1 0 9.87 7 7 0 0 1-9.94 0 7 7 0 0 1 0-9.87L12 2.69z",
            heart: "M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z",
            star: "M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z",
            monitor: "M4 6h16a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2z M12 18v4 M8 22h8",
            briefcase: "M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2 M9 4h6 M9 4a2 2 0 0 1-2-2v0a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v0a2 2 0 0 1-2 2",
            home: "M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z M9 22V12h6v10",
            check: "M20 6L9 17l-5-5",
            plus: "M12 5v14M5 12h14",
            x: "M18 6L6 18M6 6l12 12",
            layers: "M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5",
            piechart: "M21.21 15.89A10 10 0 1 1 8 2.83M22 12A10 10 0 0 0 12 2v10z",
            rotateccw: "M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8 M3 3v5h5",
            chevronDown: "M6 9l6 6 6-6",
            folderPlus: "M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z M12 11v6 M9 14h6",
            calendar: "M19 4H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z M16 2v4 M8 2v4 M3 10h18",
            grid: "M3 3h7v7H3z M14 3h7v7h-7z M14 14h7v7h-7z M3 14h7v7H3z",
            trendingUp: "M23 6l-9.5 9.5-5-5L1 18",
            barChart: "M12 20V10 M18 20V4 M6 20v-6"
        };

        const Icon = ({ name, size = 20, className, strokeWidth = 2 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}><path d={ICON_PATHS[name] || ICON_PATHS['activity']} /></svg>
        );

        // --- 2. Chart Components (Fixed Tooltips) ---

        // Line Chart
        const SimpleLineChart = ({ data, color = "#0078D4", height = 200 }) => {
            if (!data || data.length < 2) return <div style={{height}} className="flex items-center justify-center text-gray-300">Not enough data</div>;
            
            const maxVal = Math.max(...data.map(d => d.value), 1);
            const points = data.map((d, i) => {
                const x = (i / (data.length - 1)) * 100;
                const y = 100 - (d.value / maxVal) * 85; 
                return `${x},${y}`;
            }).join(' ');

            return (
                <div className="relative w-full overflow-visible mt-6" style={{ height: `${height}px` }}>
                    {/* SVG Layer */}
                    <svg viewBox="0 0 100 100" preserveAspectRatio="none" className="w-full h-full overflow-visible absolute top-0 left-0 z-0">
                        <defs>
                            <linearGradient id="lineGradient" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="0%" stopColor={color} stopOpacity="0.2" />
                                <stop offset="100%" stopColor={color} stopOpacity="0" />
                            </linearGradient>
                        </defs>
                        <path d={`M0,100 ${points} L100,100 Z`} fill="url(#lineGradient)" stroke="none" />
                        <polyline points={points} fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" vectorEffect="non-scaling-stroke" />
                    </svg>

                    {/* Interactive Layer (HTML for robust tooltips) */}
                    <div className="absolute inset-0 flex items-end justify-between z-10">
                        {data.map((d, i) => (
                            <div key={i} className="flex-1 h-full tooltip-container relative hover:bg-black/5 transition-colors cursor-crosshair">
                                {/* Tooltip */}
                                <div className="tooltip-content absolute bottom-full left-1/2 -mb-2 bg-gray-800 text-white text-xs px-3 py-1.5 rounded-md whitespace-nowrap opacity-0 transition-all duration-200 z-50 shadow-xl pointer-events-none">
                                    <div className="font-bold">{d.value}</div>
                                    <div className="text-[10px] text-gray-400">{d.label}</div>
                                    {/* Arrow */}
                                    <div className="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-gray-800"></div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // Bar Chart
        const SimpleBarChart = ({ data, color = "#0078D4", height = 200 }) => {
            if (!data) return null;
            const maxVal = Math.max(...data.map(d => d.value), 1);

            return (
                <div className="flex items-end justify-between gap-3 w-full mt-6" style={{ height: `${height}px` }}>
                    {data.map((d, i) => (
                        <div key={i} className="flex-1 h-full flex flex-col justify-end group tooltip-container">
                            {/* Bar Wrapper */}
                            <div className="w-full bg-gray-100 rounded-t-lg relative flex items-end h-full hover:bg-gray-200 transition-colors overflow-hidden">
                                <div 
                                    style={{ height: `${(d.value / maxVal) * 100}%`, backgroundColor: color }} 
                                    className="w-full rounded-t-lg transition-all duration-500 relative opacity-90 group-hover:opacity-100"
                                ></div>
                            </div>
                            
                            {/* Label */}
                            <div className="text-center mt-2">
                                <span className="text-[10px] text-gray-400 font-bold uppercase tracking-wider">{d.label}</span>
                            </div>

                            {/* Tooltip (Fixed Z-Index & Position) */}
                            <div className="tooltip-content absolute bottom-[100%] left-1/2 -mb-2 bg-gray-800 text-white text-xs px-3 py-1.5 rounded-md z-50 opacity-0 transition-all duration-200 shadow-xl pointer-events-none">
                                <span className="font-bold">{d.value}</span> Logs
                                <div className="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-gray-800"></div>
                            </div>
                        </div>
                    ))}
                </div>
            );
        };


        // --- 3. Analytics View Component ---
        const AnalyticsView = ({ habits }) => {
            const [selectedId, setSelectedId] = useState('all');
            const [viewMode, setViewMode] = useState('year'); // 'year' | 'month'
            const [chartType, setChartType] = useState('trend'); // 'trend' (line) | 'frequency' (bar)

            // --- Data Processing ---
            const processedData = useMemo(() => {
                const targetHabits = selectedId === 'all' ? habits : habits.filter(h => h.id === selectedId);
                let allLogs = [];
                targetHabits.forEach(h => { allLogs = [...allLogs, ...h.logs]; });
                allLogs.sort((a, b) => a - b);

                // Heatmap Data
                const dateMap = {};
                allLogs.forEach(ts => {
                    const date = new Date(ts).toISOString().split('T')[0];
                    dateMap[date] = (dateMap[date] || 0) + 1;
                });

                // Line Chart (Last 30 Days)
                const last30Days = [];
                for(let i=29; i>=0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    const dateStr = d.toISOString().split('T')[0];
                    last30Days.push({
                        label: d.toLocaleDateString('en-US', { day: 'numeric', month: 'short' }),
                        value: dateMap[dateStr] || 0
                    });
                }

                // Bar Chart (Day of Week)
                const dowCounts = [0,0,0,0,0,0,0];
                allLogs.forEach(ts => { const dow = new Date(ts).getDay(); dowCounts[dow]++; });
                const dowData = [
                    { label: 'Mon', value: dowCounts[1] }, { label: 'Tue', value: dowCounts[2] },
                    { label: 'Wed', value: dowCounts[3] }, { label: 'Thu', value: dowCounts[4] },
                    { label: 'Fri', value: dowCounts[5] }, { label: 'Sat', value: dowCounts[6] },
                    { label: 'Sun', value: dowCounts[0] },
                ];

                return { dateMap, last30Days, dowData, totalLogs: allLogs.length };
            }, [habits, selectedId]);

            const getColorLevel = (count) => {
                if (count === 0) return 'bg-gray-100';
                if (count <= 1) return 'bg-blue-200';
                if (count <= 3) return 'bg-blue-400';
                return 'bg-fluent-blue';
            };

            const yearDays = useMemo(() => Array.from({ length: 364 }, (_, i) => { 
                const d = new Date(); d.setDate(d.getDate() - (363 - i)); return d; 
            }), []);

            const months = useMemo(() => Array.from({length: 12}, (_, i) => {
                 const d = new Date(); d.setMonth(d.getMonth() - i); return d;
            }), []);

            return (
                <div className="max-w-5xl mx-auto space-y-6 animate-fade-in pb-20">
                    
                    {/* Filter Pills */}
                    <div className="flex gap-2 overflow-x-auto pb-2 custom-scroll">
                        <button onClick={() => setSelectedId('all')} className={`px-4 py-1.5 rounded-full text-sm font-semibold whitespace-nowrap transition-all border ${selectedId === 'all' ? 'bg-fluent-blue text-white border-transparent shadow-md' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}`}>All Habits</button>
                        {habits.map(h => (
                            <button key={h.id} onClick={() => setSelectedId(h.id)} className={`px-4 py-1.5 rounded-full text-sm font-semibold whitespace-nowrap transition-all border flex items-center gap-2 ${selectedId === h.id ? 'bg-fluent-blue text-white border-transparent shadow-md' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}`}>
                                <Icon name={h.icon} size={14} />{h.name}
                            </button>
                        ))}
                    </div>

                    {/* Heatmap Card */}
                    <div className="bg-white rounded-2xl shadow-card border border-gray-100 overflow-hidden relative">
                        <div className="p-6 border-b border-gray-100 flex justify-between items-center">
                            <div>
                                <h3 className="text-lg font-bold text-gray-800">Consistency Map</h3>
                                <p className="text-sm text-gray-500">{processedData.totalLogs} logs in past year</p>
                            </div>
                            <div className="flex bg-gray-100 p-1 rounded-lg">
                                <button onClick={() => setViewMode('year')} className={`px-3 py-1.5 rounded-md text-xs font-bold transition-all ${viewMode === 'year' ? 'bg-white text-fluent-blue shadow-sm' : 'text-gray-500 hover:text-gray-900'}`}>Year</button>
                                <button onClick={() => setViewMode('month')} className={`px-3 py-1.5 rounded-md text-xs font-bold transition-all ${viewMode === 'month' ? 'bg-white text-fluent-blue shadow-sm' : 'text-gray-500 hover:text-gray-900'}`}>Month</button>
                            </div>
                        </div>

                        <div className="p-6 bg-white transition-all duration-500">
                            {viewMode === 'year' ? (
                                <div className="animate-fade-in">
                                    <div className="flex flex-col h-32 flex-wrap content-start gap-1 overflow-hidden">
                                        {yearDays.map((day, i) => {
                                            const dateStr = day.toISOString().split('T')[0];
                                            const count = processedData.dateMap[dateStr] || 0;
                                            return <div key={i} className={`w-3 h-3 rounded-[2px] ${getColorLevel(count)} tooltip-container`} title={`${dateStr}: ${count}`}></div>;
                                        })}
                                    </div>
                                    <div className="flex justify-end items-center gap-2 mt-4 text-xs text-gray-400">
                                        <span>Less</span>
                                        {[0,1,3,5].map((l,i)=><div key={i} className={`w-3 h-3 rounded-[2px] ${getColorLevel(l)}`}></div>)}
                                        <span>More</span>
                                    </div>
                                </div>
                            ) : (
                                /* Increased Height for Month View */
                                <div className="h-[600px] overflow-y-auto custom-scroll pr-2 animate-slide-up space-y-8">
                                    {months.map((m, idx) => {
                                        const daysInMonth = [];
                                        const date = new Date(m.getFullYear(), m.getMonth(), 1);
                                        while (date.getMonth() === m.getMonth()) { daysInMonth.push(new Date(date)); date.setDate(date.getDate() + 1); }
                                        return (
                                            <div key={idx}>
                                                <h4 className="text-sm font-bold text-gray-700 mb-3 sticky top-0 bg-white/95 backdrop-blur-sm py-2 z-10 border-b border-gray-100">
                                                    {m.toLocaleString('default', { month: 'long', year: 'numeric' })}
                                                </h4>
                                                <div className="grid grid-cols-7 sm:grid-cols-10 md:grid-cols-14 gap-2">
                                                    {daysInMonth.map(d => {
                                                        const dateStr = d.toISOString().split('T')[0];
                                                        const count = processedData.dateMap[dateStr] || 0;
                                                        return (
                                                            <div key={dateStr} className="flex flex-col items-center gap-1 group">
                                                                <div className={`w-full aspect-square rounded-md ${getColorLevel(count)} transition-all group-hover:scale-110`}></div>
                                                                <span className="text-[10px] text-gray-300 group-hover:text-gray-500">{d.getDate()}</span>
                                                            </div>
                                                        )
                                                    })}
                                                </div>
                                            </div>
                                        )
                                    })}
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Combined Chart Section */}
                    <div className="bg-white rounded-2xl shadow-card border border-gray-100 p-6">
                        <div className="flex justify-between items-center mb-2">
                            <div>
                                <h3 className="text-lg font-bold text-gray-800">
                                    {chartType === 'trend' ? '30 Day Trend' : 'Weekly Frequency'}
                                </h3>
                                <p className="text-xs text-gray-400">
                                    {chartType === 'trend' ? 'Volume over time' : 'Activity by day of week'}
                                </p>
                            </div>
                            {/* Chart Toggle */}
                            <div className="flex bg-gray-100 p-1 rounded-lg">
                                <button onClick={() => setChartType('trend')} className={`flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-bold transition-all ${chartType === 'trend' ? 'bg-white text-fluent-blue shadow-sm' : 'text-gray-500 hover:text-gray-900'}`}>
                                    <Icon name="trendingUp" size={14} /> Trend
                                </button>
                                <button onClick={() => setChartType('frequency')} className={`flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-bold transition-all ${chartType === 'frequency' ? 'bg-white text-fluent-blue shadow-sm' : 'text-gray-500 hover:text-gray-900'}`}>
                                    <Icon name="barChart" size={14} /> Freq
                                </button>
                            </div>
                        </div>

                        {/* Chart Render */}
                        <div className="animate-fade-in relative z-0">
                            {chartType === 'trend' ? (
                                <SimpleLineChart data={processedData.last30Days} height={250} />
                            ) : (
                                <SimpleBarChart data={processedData.dowData} height={250} />
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- 4. Shared Components (Unchanged) ---
        const AddHabitModal = ({ isOpen, onClose, onAdd, existingGroups }) => {
            const [name, setName] = useState('');
            const [icon, setIcon] = useState('activity');
            const [size, setSize] = useState('small');
            const [groupMode, setGroupMode] = useState('select');
            const [selectedGroup, setSelectedGroup] = useState('General');
            const [newGroupName, setNewGroupName] = useState('');
            useEffect(() => {
                if (isOpen) {
                    setName(''); setIcon('activity'); setGroupMode('select');
                    setSelectedGroup(existingGroups.length > 0 ? existingGroups[0] : 'General');
                    setNewGroupName('');
                }
            }, [isOpen, existingGroups]);
            if (!isOpen) return null;
            const handleSubmit = (e) => {
                e.preventDefault();
                const finalGroup = groupMode === 'input' ? (newGroupName || 'General') : selectedGroup;
                onAdd({ id: Date.now().toString(), name, icon, size, group: finalGroup, logs: [] });
                onClose();
            };
            return (
                <div className="fixed inset-0 bg-black/20 backdrop-blur-[2px] flex items-center justify-center z-50">
                    <div className="bg-white rounded-xl w-full max-w-lg shadow-2xl overflow-hidden border border-gray-100 animate-pop-fast transform origin-center">
                        <div className="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                            <h2 className="text-lg font-semibold text-fluent-text">New Habit</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-800 hover:bg-gray-200 rounded-md p-1 transition-colors"><Icon name="x" size={20} /></button>
                        </div>
                        <form onSubmit={handleSubmit} className="p-6 space-y-6">
                            <div><label className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 block">Name</label><input required type="text" value={name} onChange={e => setName(e.target.value)} className="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:outline-none focus:ring-2 focus:ring-fluent-blue/20 focus:border-fluent-blue transition-all" placeholder="What to track?" autoFocus /></div>
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 block">Group</label>
                                {groupMode === 'select' ? (
                                    <div className="relative group"><select value={selectedGroup} onChange={(e) => {if (e.target.value === '__NEW__') setGroupMode('input'); else setSelectedGroup(e.target.value);}} className="w-full px-4 py-3 appearance-none bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:outline-none focus:ring-2 focus:ring-fluent-blue/20 focus:border-fluent-blue cursor-pointer transition-all">{existingGroups.map(g => <option key={g} value={g}>{g}</option>)}<option disabled>──────────</option><option value="__NEW__">+ Create New Group</option></select><div className="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"><Icon name="chevronDown" size={16} /></div></div>
                                ) : (
                                    <div className="flex gap-2 animate-fade-in"><input type="text" autoFocus value={newGroupName} onChange={e => setNewGroupName(e.target.value)} placeholder="Group Name" className="w-full px-4 py-3 bg-white border border-fluent-blue rounded-lg focus:outline-none focus:ring-2 focus:ring-fluent-blue/20"/><button type="button" onClick={() => setGroupMode('select')} className="text-sm font-semibold text-gray-500 hover:text-gray-800 px-3">Cancel</button></div>
                                )}
                            </div>
                            <div><label className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 block">Icon</label><div className="p-3 border border-gray-200 rounded-xl bg-gray-50/50 max-h-32 overflow-y-auto custom-scroll"><div className="grid grid-cols-8 gap-2">{Object.keys(ICON_PATHS).filter(k => !['check','plus','x','layers','piechart','rotateccw','chevronDown','folderPlus','calendar','grid','trendingUp','barChart'].includes(k)).map(i => (<button key={i} type="button" onClick={() => setIcon(i)} className={`aspect-square rounded-lg flex items-center justify-center transition-all ${icon === i ? 'bg-fluent-blue text-white shadow-md scale-105' : 'bg-white text-gray-400 hover:bg-gray-100 hover:text-fluent-blue'}`}><Icon name={i} size={18} /></button>))}</div></div></div>
                            <div><label className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 block">Size</label><div className="grid grid-cols-3 gap-3">{['small', 'medium', 'large'].map(s => (<button key={s} type="button" onClick={() => setSize(s)} className={`py-2 px-3 border rounded-lg text-sm font-medium capitalize transition-all ${size === s ? 'border-fluent-blue bg-blue-50/10 text-fluent-blue ring-1 ring-fluent-blue/50' : 'border-gray-200 text-gray-600 hover:bg-gray-100'}`}>{s}</button>))}</div></div>
                            <div className="pt-4 flex justify-end gap-3 border-t border-gray-100"><button type="button" onClick={onClose} className="px-5 py-2 text-sm font-medium text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">Cancel</button><button type="submit" className="px-6 py-2 text-sm font-bold bg-fluent-blue text-white rounded-lg hover:bg-fluent-blueHover shadow-lg shadow-blue-500/30 transition-all active:scale-95">Create Habit</button></div>
                        </form>
                    </div>
                </div>
            );
        };
        const AddGroupDialog = ({ isOpen, onClose, onAdd }) => {
            const [name, setName] = useState('');
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/20 backdrop-blur-[1px] flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg p-5 w-80 shadow-2xl animate-pop-fast"><h3 className="font-semibold text-lg mb-4">New Group</h3><input autoFocus type="text" value={name} onChange={e=>setName(e.target.value)} className="w-full border p-2 rounded mb-4 focus:outline-none focus:border-fluent-blue" placeholder="e.g. Wellness" /><div className="flex justify-end gap-2"><button onClick={onClose} className="px-3 py-1.5 text-sm text-gray-500 hover:bg-gray-100 rounded">Cancel</button><button onClick={() => { if(name) { onAdd(name); onClose(); setName(''); } }} className="px-3 py-1.5 text-sm bg-fluent-blue text-white rounded font-medium">Add Group</button></div></div>
                </div>
            )
        }
        const HabitCard = ({ habit, onLog, onUndo, onDragStart }) => {
            const [showUndo, setShowUndo] = useState(false);
            const undoTimer = useRef(null);
            const todayStr = new Date().toISOString().split('T')[0];
            const todayCount = habit.logs.filter(ts => new Date(ts).toISOString().split('T')[0] === todayStr).length;
            const sizeClasses = { small: 'col-span-1 row-span-1', medium: 'col-span-2 row-span-1', large: 'col-span-2 row-span-2' };
            const handleClick = (e) => { if (e.target.closest('button')) return; onLog(habit.id); setShowUndo(true); if (undoTimer.current) clearTimeout(undoTimer.current); undoTimer.current = setTimeout(() => setShowUndo(false), 3500); };
            const handleUndoClick = (e) => { e.stopPropagation(); onUndo(habit.id); setShowUndo(false); if (undoTimer.current) clearTimeout(undoTimer.current); };
            return (
                <div draggable="true" onDragStart={(e) => onDragStart(e, habit.id)} className={`relative bg-white/80 backdrop-blur-sm rounded-2xl shadow-card hover:shadow-card-hover hover:-translate-y-1 transition-all duration-300 cursor-pointer group select-none overflow-hidden ${sizeClasses[habit.size]}`} onClick={handleClick}>
                    <div className="h-full flex flex-col justify-between p-5 relative z-10"><div className="flex justify-between items-start"><div className={`p-3 rounded-xl transition-all duration-300 ${todayCount > 0 ? 'bg-fluent-blue/10 text-fluent-blue' : 'bg-gray-50 text-gray-400 group-hover:bg-blue-50 group-hover:text-fluent-blue'}`}><Icon name={habit.icon} size={24} strokeWidth={2} /></div><span className={`text-4xl font-bold tracking-tight transition-colors duration-300 ${todayCount > 0 ? 'text-gray-900' : 'text-gray-200 group-hover:text-gray-300'}`}>{todayCount}</span></div><div><h3 className="font-bold text-gray-800 truncate text-lg leading-tight">{habit.name}</h3><p className="text-xs text-gray-400 font-medium mt-1 uppercase tracking-wider">{todayCount === 0 ? 'Tap to log' : 'Streak Active'}</p></div></div>
                    {showUndo && (<div className="absolute right-0 top-0 bottom-0 w-24 bg-gradient-to-l from-white via-white to-transparent flex items-center justify-end pr-4 animate-fade-in z-20"><button onClick={handleUndoClick} className="flex flex-col items-center justify-center gap-1 text-fluent-danger bg-red-50 hover:bg-red-100 px-3 py-2 rounded-lg transition-colors shadow-sm border border-red-100"><Icon name="rotateccw" size={18} /><span className="text-[10px] font-bold">UNDO</span></button></div>)}
                </div>
            );
        };
        const HabitGroupSection = ({ title, habits, onLog, onUndo, onDropHabit }) => {
            const [isDragOver, setIsDragOver] = useState(false);
            const handleDrop = (e) => { e.preventDefault(); setIsDragOver(false); const habitId = e.dataTransfer.getData("habitId"); if (habitId) onDropHabit(habitId, title); };
            return (
                <div className={`p-6 rounded-2xl transition-all duration-300 border border-transparent ${isDragOver ? 'drop-zone-active scale-[1.01]' : 'bg-transparent hover:bg-white/40'}`} onDragOver={(e) => { e.preventDefault(); setIsDragOver(true); }} onDragLeave={() => setIsDragOver(false)} onDrop={handleDrop}>
                    <div className="flex items-center gap-3 mb-5"><h3 className="font-bold text-gray-800 text-lg">{title}</h3><span className="text-xs font-bold text-gray-400 bg-gray-200/50 px-2 py-1 rounded-md">{habits.length}</span></div>
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-5">{habits.map(habit => (<HabitCard key={habit.id} habit={habit} onLog={onLog} onUndo={onUndo} onDragStart={(e, id) => e.dataTransfer.setData("habitId", id)} />))}{habits.length === 0 && <div className="col-span-full h-24 border-2 border-dashed border-gray-200 rounded-xl flex items-center justify-center text-gray-400 text-sm font-medium">Drag habits here</div>}</div>
                </div>
            );
        };

        const App = () => {
            const [habits, setHabits] = useState([]);
            const [groupList, setGroupList] = useState(['General']); 
            const [tab, setTab] = useState('home');
            const [isHabitModalOpen, setIsHabitModalOpen] = useState(false);
            const [isGroupModalOpen, setIsGroupModalOpen] = useState(false);
            useEffect(() => {
                const savedHabits = localStorage.getItem('fluent-habit-final-habits');
                const savedGroups = localStorage.getItem('fluent-habit-final-groups');
                if (savedHabits) setHabits(JSON.parse(savedHabits)); else setHabits([{ id: '1', name: 'Drink Water', icon: 'droplet', size: 'small', group: 'General', logs: [] }]);
                if (savedGroups) setGroupList(JSON.parse(savedGroups)); else setGroupList(['General', 'Work', 'Health']);
            }, []);
            useEffect(() => { localStorage.setItem('fluent-habit-final-habits', JSON.stringify(habits)); localStorage.setItem('fluent-habit-final-groups', JSON.stringify(groupList)); }, [habits, groupList]);
            const addHabit = (habit) => { setHabits([...habits, habit]); if (!groupList.includes(habit.group)) setGroupList([...groupList, habit.group]); };
            const addGroup = (name) => { if (!groupList.includes(name)) setGroupList([...groupList, name]); };
            const logHabit = (id) => { const timestamp = Date.now(); setHabits(prev => prev.map(h => h.id === id ? { ...h, logs: [...h.logs, timestamp] } : h)); };
            const undoLog = (id) => { setHabits(prev => prev.map(h => { if (h.id !== id) return h; const newLogs = [...h.logs]; newLogs.pop(); return { ...h, logs: newLogs }; })); };
            const handleDropHabit = (id, group) => { setHabits(prev => prev.map(h => h.id === id ? { ...h, group } : h)); };
            return (
                <div className="flex h-screen w-full bg-fluent-bg font-sans overflow-hidden">
                    <aside className="w-64 bg-white border-r border-gray-200 flex flex-col h-full z-20"><div className="p-6 flex items-center gap-3"><div className="bg-fluent-blue text-white p-2 rounded-lg shadow-md"><Icon name="layers" size={24} /></div><h1 className="text-xl font-bold text-gray-800 tracking-tight">HabitFlow</h1></div><nav className="flex-1 px-4 py-2 space-y-2"><button onClick={() => setTab('home')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-semibold transition-all ${tab === 'home' ? 'bg-blue-50 text-fluent-blue' : 'text-gray-500 hover:bg-gray-50 hover:text-gray-900'}`}><Icon name="home" size={20} /> Dashboard</button><button onClick={() => setTab('activity')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-semibold transition-all ${tab === 'activity' ? 'bg-blue-50 text-fluent-blue' : 'text-gray-500 hover:bg-gray-50 hover:text-gray-900'}`}><Icon name="piechart" size={20} /> Analytics</button></nav><div className="p-4 text-xs text-center text-gray-300">v2.3 Final</div></aside>
                    <main className="flex-1 flex flex-col h-full relative"><header className="px-10 py-6 flex justify-between items-center bg-fluent-bg/80 backdrop-blur-md sticky top-0 z-10"><div><h2 className="text-3xl font-bold text-gray-900">{tab === 'home' ? 'My Dashboard' : 'Analysis'}</h2><p className="text-gray-500 mt-1 font-medium">{new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}</p></div>{tab === 'home' && (<div className="flex gap-3"><button onClick={() => setIsGroupModalOpen(true)} className="flex items-center gap-2 bg-white text-gray-600 border border-gray-200 hover:bg-gray-50 px-4 py-2.5 rounded-xl shadow-sm transition-all active:scale-95 font-semibold text-sm"><Icon name="folderPlus" size={18} /><span>Group</span></button><button onClick={() => setIsHabitModalOpen(true)} className="flex items-center gap-2 bg-fluent-blue hover:bg-fluent-blueHover text-white px-5 py-2.5 rounded-xl shadow-lg shadow-blue-500/20 transition-all active:scale-95 group font-bold text-sm"><Icon name="plus" size={18} strokeWidth={3} /><span>New Habit</span></button></div>)}</header><div className="flex-1 overflow-y-auto px-10 pb-20 custom-scroll">{tab === 'home' ? (<div className="space-y-4">{groupList.map(groupName => (<HabitGroupSection key={groupName} title={groupName} habits={habits.filter(h => (h.group || 'General') === groupName)} onLog={logHabit} onUndo={undoLog} onDropHabit={handleDropHabit} />))}{habits.some(h => !groupList.includes(h.group || 'General')) && (<HabitGroupSection title="Uncategorized" habits={habits.filter(h => !groupList.includes(h.group || 'General'))} onLog={logHabit} onUndo={undoLog} onDropHabit={handleDropHabit} />)}</div>) : (<AnalyticsView habits={habits} />)}</div></main>
                    <AddHabitModal isOpen={isHabitModalOpen} onClose={() => setIsHabitModalOpen(false)} onAdd={addHabit} existingGroups={groupList} />
                    <AddGroupDialog isOpen={isGroupModalOpen} onClose={() => setIsGroupModalOpen(false)} onAdd={addGroup} />
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>