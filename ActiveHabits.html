<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fluent Habit Hub - Analytics Final</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Segoe UI Variable"', '"Segoe UI"', 'sans-serif'],
                    },
                    colors: {
                        fluent: {
                            bg: "#f0f2f5",
                            blue: "#0078D4", 
                            blueHover: "#106EBE",
                            text: "#201F1E",
                            subtext: "#605E5C",
                            danger: "#C50F1F"
                        }
                    },
                    boxShadow: {
                        'card': '0 4px 12px rgba(0,0,0,0.05), 0 0 2px rgba(0,0,0,0.1)',
                        'card-hover': '0 12px 32px rgba(0,0,0,0.12), 0 0 4px rgba(0,0,0,0.15)',
                        'button': '0 2px 8px rgba(0,120,212,0.2)',
                        'button-hover': '0 4px 16px rgba(0,120,212,0.3)',
                    },
                    animation: {
                        'pop-fast': 'scaleIn 0.15s cubic-bezier(0.34, 1.56, 0.64, 1) forwards',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'fade-in': 'fadeIn 0.4s ease-out forwards',
                        'bounce-subtle': 'bounceSubtle 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55)',
                        'pulse-soft': 'pulseSoft 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'shimmer': 'shimmer 2s linear infinite',
                    },
                    keyframes: {
                        scaleIn: {
                            '0%': { transform: 'scale(0.92)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        bounceSubtle: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-8px)' },
                        },
                        pulseSoft: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.7' },
                        },
                        shimmer: {
                            '0%': { backgroundPosition: '-1000px 0' },
                            '100%': { backgroundPosition: '1000px 0' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            background-color: #f0f2f5; 
            color: #201F1E; 
            user-select: none;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .custom-scroll::-webkit-scrollbar { 
            width: 8px; 
            height: 8px;
        }
        .custom-scroll::-webkit-scrollbar-track { 
            background: transparent; 
        }
        .custom-scroll::-webkit-scrollbar-thumb { 
            background-color: #d1d5db; 
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover { 
            background-color: #9ca3af; 
        }
        
        /* Tooltip Logic Enhanced */
        .tooltip-container {
            position: relative;
        }
        .tooltip-content {
            opacity: 0;
            visibility: hidden;
            transform: translate(-50%, -4px) scale(0.96);
            pointer-events: none;
            will-change: opacity, transform;
            transition: opacity 0.2s cubic-bezier(0.4, 0, 0.2, 1),
                        transform 0.2s cubic-bezier(0.4, 0, 0.2, 1),
                        visibility 0s 0.25s;
        }
        .tooltip-container:hover .tooltip-content {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -8px) scale(1);
            transition: opacity 0.2s cubic-bezier(0.4, 0, 0.2, 1) 0.05s,
                        transform 0.2s cubic-bezier(0.4, 0, 0.2, 1) 0.05s,
                        visibility 0s;
        }
        
        /* Enhanced Button Interactions */
        button {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        button:active {
            transform: scale(0.97);
        }
        
        /* Smooth Card Transitions */
        .habit-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .habit-card:hover {
            transform: translateY(-4px) scale(1.01);
        }
        .habit-card:active {
            transform: translateY(-2px) scale(0.99);
        }
        
        /* Drag and Drop Enhancements */
        .drop-zone-active {
            background: linear-gradient(135deg, rgba(0,120,212,0.08) 0%, rgba(0,120,212,0.12) 100%);
            border-color: rgba(0,120,212,0.3) !important;
            box-shadow: 0 8px 24px rgba(0,120,212,0.15);
        }
        
        /* Modal Backdrop */
        .modal-backdrop {
            backdrop-filter: blur(4px);
            animation: fadeIn 0.2s ease-out;
        }
        
        /* Input Focus Enhancement */
        input:focus, select:focus {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,120,212,0.15);
        }
        
        /* Chart Bar Hover */
        .chart-bar {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .chart-bar:hover {
            transform: translateY(-4px);
            filter: brightness(1.1);
        }
        
        /* Icon Animation */
        .icon-bounce {
            animation: bounceSubtle 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        /* Smooth Number Transitions */
        .number-transition {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- 1. Icons Path Data ---
        const ICON_PATHS = {
            activity: "M22 12h-4l-3 9L9 3l-3 9H2",
            book: "M4 19.5A2.5 2.5 0 0 1 6.5 17H20 M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z",
            code: "M16 18l6-6-6-6 M8 6l-6 6 6 6",
            coffee: "M18 8h1a4 4 0 0 1 0 8h-1 M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z M6 1v3 M10 1v3 M14 1v3",
            dumbbell: "M6.5 6.5l11 11 M21 21l-1-1 M3 3l1 1 M18 22l4-4 M2 6l4-4 M3 10l7.5-7.5 M13.5 21L21 13.5",
            music: "M9 18V5l12-2v13 M9 9l12-2 M6 18a3 3 0 1 0 6 0 3 3 0 0 0-6 0z M18 16a3 3 0 1 0 6 0 3 3 0 0 0-6 0z",
            sun: "M12 2v2 M12 20v2 M4.93 4.93l1.41 1.41 M17.66 17.66l1.41 1.41 M2 12h2 M20 12h2 M6.34 17.66l-1.41 1.41 M19.07 4.93l-1.41 1.41 M12 7a5 5 0 1 0 0 10 5 5 0 0 0 0-10z",
            moon: "M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9z",
            zap: "M13 2L3 14h9l-1 8 10-12h-9l1-8z",
            droplet: "M12 2.69l5.74 5.82a7 7 0 0 1 0 9.87 7 7 0 0 1-9.94 0 7 7 0 0 1 0-9.87L12 2.69z",
            heart: "M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z",
            star: "M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z",
            monitor: "M4 6h16a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2z M12 18v4 M8 22h8",
            briefcase: "M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2 M9 4h6 M9 4a2 2 0 0 1-2-2v0a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v0a2 2 0 0 1-2 2",
            home: "M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z M9 22V12h6v10",
            check: "M20 6L9 17l-5-5",
            plus: "M12 5v14M5 12h14",
            x: "M18 6L6 18M6 6l12 12",
            layers: "M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5",
            piechart: "M21.21 15.89A10 10 0 1 1 8 2.83M22 12A10 10 0 0 0 12 2v10z",
            rotateccw: "M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8 M3 3v5h5",
            chevronDown: "M6 9l6 6 6-6",
            folderPlus: "M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z M12 11v6 M9 14h6",
            calendar: "M19 4H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z M16 2v4 M8 2v4 M3 10h18",
            grid: "M3 3h7v7H3z M14 3h7v7h-7z M14 14h7v7h-7z M3 14h7v7H3z",
            trendingUp: "M23 6l-9.5 9.5-5-5L1 18",
            barChart: "M12 20V10 M18 20V4 M6 20v-6"
        };

        const Icon = ({ name, size = 20, className, strokeWidth = 2 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}><path d={ICON_PATHS[name] || ICON_PATHS['activity']} /></svg>
        );

        // --- 2. Chart Components (Fixed Tooltips) ---

        // Line Chart
        const SimpleLineChart = ({ data, color = "#0078D4", height = 200 }) => {
            if (!data || data.length < 2) return <div style={{height}} className="flex items-center justify-center text-gray-300">Not enough data</div>;
            
            const maxVal = Math.max(...data.map(d => d.value), 1);
            const points = data.map((d, i) => {
                const x = (i / (data.length - 1)) * 100;
                const y = 100 - (d.value / maxVal) * 85; 
                return `${x},${y}`;
            }).join(' ');

            return (
                <div className="relative w-full mt-6" style={{ height: `${height}px`, paddingTop: '20px', paddingBottom: '10px' }}>
                    {/* SVG Layer */}
                    <svg viewBox="0 0 100 100" preserveAspectRatio="none" className="w-full h-full absolute top-0 left-0 z-0" style={{ height: `${height}px` }}>
                        <defs>
                            <linearGradient id="lineGradient" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="0%" stopColor={color} stopOpacity="0.25" />
                                <stop offset="100%" stopColor={color} stopOpacity="0" />
                            </linearGradient>
                        </defs>
                        <path d={`M0,100 ${points} L100,100 Z`} fill="url(#lineGradient)" stroke="none" className="transition-opacity duration-300" />
                        <polyline points={points} fill="none" stroke={color} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" vectorEffect="non-scaling-stroke" className="transition-all duration-300" />
                    </svg>

                    {/* Interactive Layer (HTML for robust tooltips) */}
                    <div className="absolute inset-0 flex items-end justify-between z-10" style={{ paddingTop: '20px', paddingBottom: '10px' }}>
                        {data.map((d, i) => (
                            <div key={i} className="flex-1 h-full tooltip-container relative hover:bg-black/5 transition-all duration-200 cursor-crosshair rounded-sm group">
                                {/* Hover Indicator */}
                                <div className="absolute bottom-0 left-1/2 -translate-x-1/2 w-1 h-1 bg-fluent-blue rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-200"></div>
                                {/* Tooltip */}
                                <div className="tooltip-content absolute bottom-full left-1/2 -mb-3 bg-gray-900 text-white text-xs px-4 py-2 rounded-lg whitespace-nowrap z-[100] shadow-2xl pointer-events-none border border-gray-700">
                                    <div className="font-bold text-sm mb-0.5">{d.value}</div>
                                    <div className="text-[10px] text-gray-300">{d.label}</div>
                                    {/* Arrow */}
                                    <div className="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // Bar Chart
        const SimpleBarChart = ({ data, color = "#0078D4", height = 200 }) => {
            if (!data) return null;
            const maxVal = Math.max(...data.map(d => d.value), 1);

            return (
                <div className="flex items-end justify-between gap-3 w-full mt-6 relative" style={{ height: `${height}px`, paddingTop: '20px' }}>
                    {data.map((d, i) => (
                        <div key={i} className="flex-1 h-full flex flex-col justify-end group tooltip-container relative">
                            {/* Bar Wrapper */}
                            <div className="w-full bg-gray-100 rounded-t-xl relative flex items-end h-full hover:bg-gray-200 transition-all duration-300 overflow-hidden shadow-inner">
                                <div 
                                    style={{ height: `${(d.value / maxVal) * 100}%`, backgroundColor: color }} 
                                    className="w-full rounded-t-xl transition-all duration-500 relative opacity-90 group-hover:opacity-100 chart-bar group-hover:shadow-lg"
                                >
                                    {/* Shine Effect */}
                                    <div className="absolute inset-0 bg-gradient-to-t from-transparent via-white/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                                </div>
                            </div>
                            
                            {/* Label */}
                            <div className="text-center mt-3">
                                <span className="text-[10px] text-gray-500 font-bold uppercase tracking-wider transition-colors duration-200 group-hover:text-gray-700">{d.label}</span>
                            </div>

                            {/* Tooltip (Fixed Z-Index & Position) */}
                            <div className="tooltip-content absolute bottom-[100%] left-1/2 -mb-3 bg-gray-900 text-white text-xs px-4 py-2 rounded-lg z-[100] shadow-2xl pointer-events-none border border-gray-700">
                                <span className="font-bold text-sm">{d.value}</span> <span className="text-gray-300">Logs</span>
                                <div className="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                            </div>
                        </div>
                    ))}
                </div>
            );
        };


        // --- 3. Analytics View Component ---
        const AnalyticsView = ({ habits }) => {
            const [selectedId, setSelectedId] = useState('all');
            const [viewMode, setViewMode] = useState('year'); // 'year' | 'month'
            const [chartType, setChartType] = useState('trend'); // 'trend' (line) | 'frequency' (bar)

            // --- Data Processing ---
            const processedData = useMemo(() => {
                const targetHabits = selectedId === 'all' ? habits : habits.filter(h => h.id === selectedId);
                let allLogs = [];
                targetHabits.forEach(h => { allLogs = [...allLogs, ...h.logs]; });
                allLogs.sort((a, b) => a - b);

                // Heatmap Data
                const dateMap = {};
                allLogs.forEach(ts => {
                    const date = new Date(ts).toISOString().split('T')[0];
                    dateMap[date] = (dateMap[date] || 0) + 1;
                });

                // Line Chart (Last 30 Days)
                const last30Days = [];
                for(let i=29; i>=0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    const dateStr = d.toISOString().split('T')[0];
                    last30Days.push({
                        label: d.toLocaleDateString('en-US', { day: 'numeric', month: 'short' }),
                        value: dateMap[dateStr] || 0
                    });
                }

                // Bar Chart (Day of Week)
                const dowCounts = [0,0,0,0,0,0,0];
                allLogs.forEach(ts => { const dow = new Date(ts).getDay(); dowCounts[dow]++; });
                const dowData = [
                    { label: 'Mon', value: dowCounts[1] }, { label: 'Tue', value: dowCounts[2] },
                    { label: 'Wed', value: dowCounts[3] }, { label: 'Thu', value: dowCounts[4] },
                    { label: 'Fri', value: dowCounts[5] }, { label: 'Sat', value: dowCounts[6] },
                    { label: 'Sun', value: dowCounts[0] },
                ];

                return { dateMap, last30Days, dowData, totalLogs: allLogs.length };
            }, [habits, selectedId]);

            const getColorLevel = (count) => {
                if (count === 0) return 'bg-gray-100';
                if (count <= 1) return 'bg-blue-200';
                if (count <= 3) return 'bg-blue-400';
                return 'bg-fluent-blue';
            };

            const yearDays = useMemo(() => Array.from({ length: 364 }, (_, i) => { 
                const d = new Date(); d.setDate(d.getDate() - (363 - i)); return d; 
            }), []);

            const months = useMemo(() => Array.from({length: 12}, (_, i) => {
                 const d = new Date(); d.setMonth(d.getMonth() - i); return d;
            }), []);

            return (
                <div className="max-w-5xl mx-auto space-y-6 animate-fade-in pb-20 overflow-visible">
                    
                    {/* Filter Pills */}
                    <div className="flex gap-2 overflow-x-auto overflow-y-visible pb-2 custom-scroll">
                        <button onClick={() => setSelectedId('all')} className={`px-5 py-2 rounded-full text-sm font-semibold whitespace-nowrap transition-all duration-200 border ${selectedId === 'all' ? 'bg-fluent-blue text-white border-transparent shadow-button-hover scale-105' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50 hover:border-gray-300 hover:shadow-sm active:scale-95'}`}>All Habits</button>
                        {habits.map(h => (
                            <button key={h.id} onClick={() => setSelectedId(h.id)} className={`px-5 py-2 rounded-full text-sm font-semibold whitespace-nowrap transition-all duration-200 border flex items-center gap-2 ${selectedId === h.id ? 'bg-fluent-blue text-white border-transparent shadow-button-hover scale-105' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50 hover:border-gray-300 hover:shadow-sm active:scale-95'}`}>
                                <Icon name={h.icon} size={14} className={selectedId === h.id ? 'icon-bounce' : ''} />{h.name}
                            </button>
                        ))}
                    </div>

                    {/* Heatmap Card */}
                    <div className="bg-white rounded-2xl shadow-card border border-gray-100 overflow-visible relative">
                        <div className="p-6 border-b border-gray-100 flex justify-between items-center">
                            <div>
                                <h3 className="text-lg font-bold text-gray-800">Consistency Map</h3>
                                <p className="text-sm text-gray-500">{processedData.totalLogs} logs in past year</p>
                            </div>
                            <div className="flex bg-gray-100 p-1 rounded-lg gap-1">
                                <button onClick={() => setViewMode('year')} className={`px-4 py-2 rounded-md text-xs font-bold transition-all duration-200 ${viewMode === 'year' ? 'bg-white text-fluent-blue shadow-md scale-105' : 'text-gray-500 hover:text-gray-900 hover:bg-gray-50 active:scale-95'}`}>Year</button>
                                <button onClick={() => setViewMode('month')} className={`px-4 py-2 rounded-md text-xs font-bold transition-all duration-200 ${viewMode === 'month' ? 'bg-white text-fluent-blue shadow-md scale-105' : 'text-gray-500 hover:text-gray-900 hover:bg-gray-50 active:scale-95'}`}>Month</button>
                            </div>
                        </div>

                        <div className="p-6 bg-white transition-all duration-500 overflow-visible">
                            {viewMode === 'year' ? (
                                <div className="animate-fade-in overflow-visible">
                                    <div className="flex flex-col h-32 flex-wrap content-start gap-1 overflow-visible relative" style={{ paddingTop: '10px' }}>
                                        {yearDays.map((day, i) => {
                                            const dateStr = day.toISOString().split('T')[0];
                                            const count = processedData.dateMap[dateStr] || 0;
                                            return (
                                                <div key={i} className={`w-3 h-3 rounded-sm ${getColorLevel(count)} tooltip-container transition-all duration-200 hover:scale-125 hover:z-10 hover:shadow-md cursor-pointer relative`} title={`${dateStr}: ${count}`}>
                                                    <div className="tooltip-content absolute bottom-full left-1/2 -mb-2 bg-gray-900 text-white text-xs px-3 py-1.5 rounded-md whitespace-nowrap z-[100] shadow-xl pointer-events-none border border-gray-700">
                                                        <div className="font-bold">{count} logs</div>
                                                        <div className="text-[10px] text-gray-300">{dateStr}</div>
                                                        <div className="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                    <div className="flex justify-end items-center gap-2 mt-4 text-xs text-gray-400">
                                        <span>Less</span>
                                        {[0,1,3,5].map((l,i)=><div key={i} className={`w-3 h-3 rounded-[2px] ${getColorLevel(l)}`}></div>)}
                                        <span>More</span>
                                    </div>
                                </div>
                            ) : (
                                /* Increased Height for Month View */
                                <div className="h-[600px] overflow-y-auto overflow-x-visible custom-scroll pr-2 animate-slide-up space-y-8">
                                    {months.map((m, idx) => {
                                        const daysInMonth = [];
                                        const date = new Date(m.getFullYear(), m.getMonth(), 1);
                                        while (date.getMonth() === m.getMonth()) { daysInMonth.push(new Date(date)); date.setDate(date.getDate() + 1); }
                                        return (
                                            <div key={idx} className="overflow-visible">
                                                <h4 className="text-sm font-bold text-gray-700 mb-3 sticky top-0 bg-white/95 backdrop-blur-sm py-2 z-10 border-b border-gray-100">
                                                    {m.toLocaleString('default', { month: 'long', year: 'numeric' })}
                                                </h4>
                                                <div className="grid grid-cols-7 sm:grid-cols-10 md:grid-cols-14 gap-2 overflow-visible">
                                                    {daysInMonth.map(d => {
                                                        const dateStr = d.toISOString().split('T')[0];
                                                        const count = processedData.dateMap[dateStr] || 0;
                                                        return (
                                                            <div key={dateStr} className="flex flex-col items-center gap-1.5 group tooltip-container relative">
                                                                <div className={`w-full aspect-square rounded-lg ${getColorLevel(count)} transition-all duration-200 group-hover:scale-110 group-hover:shadow-md cursor-pointer relative overflow-hidden`}>
                                                                    {count > 0 && (
                                                                        <div className="absolute inset-0 bg-gradient-to-br from-white/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-200"></div>
                                                                    )}
                                                                </div>
                                                                <span className="text-[10px] text-gray-400 group-hover:text-gray-600 transition-colors duration-200 font-medium">{d.getDate()}</span>
                                                                <div className="tooltip-content absolute bottom-full left-1/2 -mb-2 bg-gray-900 text-white text-xs px-3 py-1.5 rounded-md whitespace-nowrap z-[100] shadow-xl pointer-events-none border border-gray-700">
                                                                    <div className="font-bold">{count} logs</div>
                                                                    <div className="text-[10px] text-gray-300">{dateStr}</div>
                                                                    <div className="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                                                                </div>
                                                            </div>
                                                        )
                                                    })}
                                                </div>
                                            </div>
                                        )
                                    })}
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Combined Chart Section */}
                    <div className="bg-white rounded-2xl shadow-card border border-gray-100 p-6 overflow-visible">
                        <div className="flex justify-between items-center mb-2">
                            <div>
                                <h3 className="text-lg font-bold text-gray-800">
                                    {chartType === 'trend' ? '30 Day Trend' : 'Weekly Frequency'}
                                </h3>
                                <p className="text-xs text-gray-400">
                                    {chartType === 'trend' ? 'Volume over time' : 'Activity by day of week'}
                                </p>
                            </div>
                            {/* Chart Toggle */}
                            <div className="flex bg-gray-100 p-1 rounded-lg gap-1">
                                <button onClick={() => setChartType('trend')} className={`flex items-center gap-1.5 px-4 py-2 rounded-md text-xs font-bold transition-all duration-200 ${chartType === 'trend' ? 'bg-white text-fluent-blue shadow-md scale-105' : 'text-gray-500 hover:text-gray-900 hover:bg-gray-50 active:scale-95'}`}>
                                    <Icon name="trendingUp" size={14} /> Trend
                                </button>
                                <button onClick={() => setChartType('frequency')} className={`flex items-center gap-1.5 px-4 py-2 rounded-md text-xs font-bold transition-all duration-200 ${chartType === 'frequency' ? 'bg-white text-fluent-blue shadow-md scale-105' : 'text-gray-500 hover:text-gray-900 hover:bg-gray-50 active:scale-95'}`}>
                                    <Icon name="barChart" size={14} /> Freq
                                </button>
                            </div>
                        </div>

                        {/* Chart Render */}
                        <div className="animate-fade-in relative" style={{ overflow: 'visible', minHeight: '290px' }}>
                            {chartType === 'trend' ? (
                                <SimpleLineChart data={processedData.last30Days} height={250} />
                            ) : (
                                <SimpleBarChart data={processedData.dowData} height={250} />
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- 4. Shared Components (Unchanged) ---
        const AddHabitModal = ({ isOpen, onClose, onAdd, existingGroups }) => {
            const [name, setName] = useState('');
            const [icon, setIcon] = useState('activity');
            const [size, setSize] = useState('small');
            const [groupMode, setGroupMode] = useState('select');
            const [selectedGroup, setSelectedGroup] = useState('General');
            const [newGroupName, setNewGroupName] = useState('');
            useEffect(() => {
                if (isOpen) {
                    setName(''); setIcon('activity'); setGroupMode('select');
                    setSelectedGroup(existingGroups.length > 0 ? existingGroups[0] : 'General');
                    setNewGroupName('');
                }
            }, [isOpen, existingGroups]);
            if (!isOpen) return null;
            const handleSubmit = (e) => {
                e.preventDefault();
                const finalGroup = groupMode === 'input' ? (newGroupName || 'General') : selectedGroup;
                onAdd({ id: Date.now().toString(), name, icon, size, group: finalGroup, logs: [] });
                onClose();
            };
            return (
                <div className="fixed inset-0 bg-black/30 modal-backdrop flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="bg-white rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden border border-gray-100 animate-pop-fast transform origin-center" onClick={(e) => e.stopPropagation()}>
                        <div className="px-6 py-5 border-b border-gray-100 flex justify-between items-center bg-gradient-to-r from-gray-50 to-white">
                            <h2 className="text-xl font-bold text-fluent-text">New Habit</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-800 hover:bg-gray-200 active:bg-gray-300 rounded-lg p-2 transition-all duration-200 active:scale-95"><Icon name="x" size={20} /></button>
                        </div>
                        <form onSubmit={handleSubmit} className="p-6 space-y-6">
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 block">Name</label>
                                <input required type="text" value={name} onChange={e => setName(e.target.value)} className="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:outline-none focus:ring-2 focus:ring-fluent-blue/30 focus:border-fluent-blue transition-all duration-200 placeholder:text-gray-400" placeholder="What to track?" autoFocus />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 block">Group</label>
                                {groupMode === 'select' ? (
                                    <div className="relative group">
                                        <select value={selectedGroup} onChange={(e) => {if (e.target.value === '__NEW__') setGroupMode('input'); else setSelectedGroup(e.target.value);}} className="w-full px-4 py-3 appearance-none bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:outline-none focus:ring-2 focus:ring-fluent-blue/30 focus:border-fluent-blue cursor-pointer transition-all duration-200">
                                            {existingGroups.map(g => <option key={g} value={g}>{g}</option>)}
                                            <option disabled>──────────</option>
                                            <option value="__NEW__">+ Create New Group</option>
                                        </select>
                                        <div className="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"><Icon name="chevronDown" size={16} /></div>
                                    </div>
                                ) : (
                                    <div className="flex gap-2 animate-fade-in">
                                        <input type="text" autoFocus value={newGroupName} onChange={e => setNewGroupName(e.target.value)} placeholder="Group Name" className="w-full px-4 py-3 bg-white border border-fluent-blue rounded-xl focus:outline-none focus:ring-2 focus:ring-fluent-blue/30 transition-all duration-200 placeholder:text-gray-400"/>
                                        <button type="button" onClick={() => setGroupMode('select')} className="text-sm font-semibold text-gray-500 hover:text-gray-800 hover:bg-gray-100 px-4 py-2 rounded-lg transition-all duration-200 active:scale-95">Cancel</button>
                                    </div>
                                )}
                            </div>
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 block">Icon</label>
                                <div className="p-4 border border-gray-200 rounded-xl bg-gray-50/50 max-h-40 overflow-y-auto custom-scroll">
                                    <div className="grid grid-cols-8 gap-2">
                                        {Object.keys(ICON_PATHS).filter(k => !['check','plus','x','layers','piechart','rotateccw','chevronDown','folderPlus','calendar','grid','trendingUp','barChart'].includes(k)).map(i => (
                                            <button key={i} type="button" onClick={() => setIcon(i)} className={`aspect-square rounded-xl flex items-center justify-center transition-all duration-200 ${icon === i ? 'bg-fluent-blue text-white shadow-md scale-110 ring-2 ring-fluent-blue/30' : 'bg-white text-gray-400 hover:bg-gray-100 hover:text-fluent-blue hover:scale-105 active:scale-95'}`}>
                                                <Icon name={i} size={18} className={icon === i ? 'icon-bounce' : ''} />
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 block">Size</label>
                                <div className="grid grid-cols-3 gap-3">
                                    {['small', 'medium', 'large'].map(s => (
                                        <button key={s} type="button" onClick={() => setSize(s)} className={`py-3 px-4 border rounded-xl text-sm font-medium capitalize transition-all duration-200 ${size === s ? 'border-fluent-blue bg-blue-50 text-fluent-blue ring-2 ring-fluent-blue/30 shadow-sm scale-105' : 'border-gray-200 text-gray-600 hover:bg-gray-50 hover:border-gray-300 active:scale-95'}`}>
                                            {s}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div className="pt-4 flex justify-end gap-3 border-t border-gray-100">
                                <button type="button" onClick={onClose} className="px-5 py-2.5 text-sm font-medium text-gray-600 hover:bg-gray-100 active:bg-gray-200 rounded-xl transition-all duration-200 active:scale-95">Cancel</button>
                                <button type="submit" className="px-6 py-2.5 text-sm font-bold bg-fluent-blue text-white rounded-xl hover:bg-fluent-blueHover shadow-button-hover transition-all duration-200 active:scale-95 flex items-center gap-2">
                                    <Icon name="plus" size={16} />
                                    Create Habit
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };
        const AddGroupDialog = ({ isOpen, onClose, onAdd }) => {
            const [name, setName] = useState('');
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/30 modal-backdrop flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="bg-white rounded-2xl p-6 w-80 shadow-2xl animate-pop-fast border border-gray-100" onClick={(e) => e.stopPropagation()}>
                        <h3 className="font-bold text-lg mb-4 text-gray-800">New Group</h3>
                        <input autoFocus type="text" value={name} onChange={e=>setName(e.target.value)} className="w-full border border-gray-200 px-4 py-3 rounded-xl mb-4 focus:outline-none focus:ring-2 focus:ring-fluent-blue/30 focus:border-fluent-blue transition-all duration-200 placeholder:text-gray-400" placeholder="e.g. Wellness" />
                        <div className="flex justify-end gap-3">
                            <button onClick={onClose} className="px-4 py-2 text-sm font-medium text-gray-600 hover:bg-gray-100 active:bg-gray-200 rounded-xl transition-all duration-200 active:scale-95">Cancel</button>
                            <button onClick={() => { if(name) { onAdd(name); onClose(); setName(''); } }} className="px-5 py-2 text-sm bg-fluent-blue text-white rounded-xl hover:bg-fluent-blueHover font-bold shadow-button-hover transition-all duration-200 active:scale-95">
                                Add Group
                            </button>
                        </div>
                    </div>
                </div>
            )
        }
        const HabitCard = ({ habit, onLog, onUndo, onDragStart }) => {
            const [showUndo, setShowUndo] = useState(false);
            const undoTimer = useRef(null);
            const todayStr = new Date().toISOString().split('T')[0];
            const todayCount = habit.logs.filter(ts => new Date(ts).toISOString().split('T')[0] === todayStr).length;
            const sizeClasses = { small: 'col-span-1 row-span-1', medium: 'col-span-2 row-span-1', large: 'col-span-2 row-span-2' };
            const handleClick = (e) => { if (e.target.closest('button')) return; onLog(habit.id); setShowUndo(true); if (undoTimer.current) clearTimeout(undoTimer.current); undoTimer.current = setTimeout(() => setShowUndo(false), 3500); };
            const handleUndoClick = (e) => { e.stopPropagation(); onUndo(habit.id); setShowUndo(false); if (undoTimer.current) clearTimeout(undoTimer.current); };
            return (
                <div draggable="true" onDragStart={(e) => onDragStart(e, habit.id)} className={`habit-card relative bg-white/90 backdrop-blur-sm rounded-2xl shadow-card hover:shadow-card-hover transition-all duration-300 cursor-pointer group select-none overflow-hidden ${sizeClasses[habit.size]}`} onClick={handleClick}>
                    <div className="h-full flex flex-col justify-between p-5 relative z-10">
                        <div className="flex justify-between items-start">
                            <div className={`p-3 rounded-xl transition-all duration-300 ${todayCount > 0 ? 'bg-fluent-blue/10 text-fluent-blue shadow-sm' : 'bg-gray-50 text-gray-400 group-hover:bg-blue-50 group-hover:text-fluent-blue group-hover:shadow-sm'}`}>
                                <Icon name={habit.icon} size={24} strokeWidth={2} className={todayCount > 0 ? 'icon-bounce' : ''} />
                            </div>
                            <span className={`number-transition text-4xl font-bold tracking-tight ${todayCount > 0 ? 'text-gray-900' : 'text-gray-200 group-hover:text-gray-300'}`}>{todayCount}</span>
                        </div>
                        <div>
                            <h3 className="font-bold text-gray-800 truncate text-lg leading-tight mb-1">{habit.name}</h3>
                            <p className={`text-xs font-medium uppercase tracking-wider transition-colors duration-200 ${todayCount === 0 ? 'text-gray-400' : 'text-fluent-blue'}`}>{todayCount === 0 ? 'Tap to log' : 'Streak Active'}</p>
                        </div>
                    </div>
                    {/* Background Gradient on Hover */}
                    <div className="absolute inset-0 bg-gradient-to-br from-fluent-blue/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none"></div>
                    {showUndo && (
                        <div className="absolute right-0 top-0 bottom-0 w-28 bg-gradient-to-l from-white via-white/95 to-transparent flex items-center justify-end pr-4 animate-fade-in z-20">
                            <button onClick={handleUndoClick} className="flex flex-col items-center justify-center gap-1 text-fluent-danger bg-red-50 hover:bg-red-100 active:bg-red-200 px-3 py-2 rounded-lg transition-all duration-200 shadow-md border border-red-100 hover:shadow-lg active:scale-95">
                                <Icon name="rotateccw" size={18} className="animate-pulse-soft" />
                                <span className="text-[10px] font-bold">UNDO</span>
                            </button>
                        </div>
                    )}
                </div>
            );
        };
        const HabitGroupSection = ({ title, habits, onLog, onUndo, onDropHabit }) => {
            const [isDragOver, setIsDragOver] = useState(false);
            const handleDrop = (e) => { e.preventDefault(); setIsDragOver(false); const habitId = e.dataTransfer.getData("habitId"); if (habitId) onDropHabit(habitId, title); };
            return (
                <div className={`p-6 rounded-2xl transition-all duration-300 border overflow-visible ${isDragOver ? 'drop-zone-active border-fluent-blue/40' : 'border-transparent bg-transparent hover:bg-white/30'}`} onDragOver={(e) => { e.preventDefault(); setIsDragOver(true); }} onDragLeave={() => setIsDragOver(false)} onDrop={handleDrop}>
                    <div className="flex items-center gap-3 mb-5">
                        <h3 className="font-bold text-gray-800 text-lg">{title}</h3>
                        <span className="text-xs font-bold text-gray-500 bg-gray-200/60 px-2.5 py-1 rounded-full">{habits.length}</span>
                    </div>
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-5 overflow-visible">
                        {habits.map(habit => (
                            <HabitCard key={habit.id} habit={habit} onLog={onLog} onUndo={onUndo} onDragStart={(e, id) => e.dataTransfer.setData("habitId", id)} />
                        ))}
                        {habits.length === 0 && (
                            <div className="col-span-full h-24 border-2 border-dashed border-gray-300 rounded-xl flex items-center justify-center text-gray-400 text-sm font-medium bg-gray-50/50 transition-colors duration-200">
                                Drag habits here
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [habits, setHabits] = useState([]);
            const [groupList, setGroupList] = useState(['General']); 
            const [tab, setTab] = useState('home');
            const [isHabitModalOpen, setIsHabitModalOpen] = useState(false);
            const [isGroupModalOpen, setIsGroupModalOpen] = useState(false);
            useEffect(() => {
                const savedHabits = localStorage.getItem('fluent-habit-final-habits');
                const savedGroups = localStorage.getItem('fluent-habit-final-groups');
                if (savedHabits) setHabits(JSON.parse(savedHabits)); else setHabits([{ id: '1', name: 'Drink Water', icon: 'droplet', size: 'small', group: 'General', logs: [] }]);
                if (savedGroups) setGroupList(JSON.parse(savedGroups)); else setGroupList(['General', 'Work', 'Health']);
            }, []);
            useEffect(() => { localStorage.setItem('fluent-habit-final-habits', JSON.stringify(habits)); localStorage.setItem('fluent-habit-final-groups', JSON.stringify(groupList)); }, [habits, groupList]);
            const addHabit = (habit) => { setHabits([...habits, habit]); if (!groupList.includes(habit.group)) setGroupList([...groupList, habit.group]); };
            const addGroup = (name) => { if (!groupList.includes(name)) setGroupList([...groupList, name]); };
            const logHabit = (id) => { const timestamp = Date.now(); setHabits(prev => prev.map(h => h.id === id ? { ...h, logs: [...h.logs, timestamp] } : h)); };
            const undoLog = (id) => { setHabits(prev => prev.map(h => { if (h.id !== id) return h; const newLogs = [...h.logs]; newLogs.pop(); return { ...h, logs: newLogs }; })); };
            const handleDropHabit = (id, group) => { setHabits(prev => prev.map(h => h.id === id ? { ...h, group } : h)); };
            return (
                <div className="flex h-screen w-full bg-fluent-bg font-sans overflow-hidden" style={{ overflowX: 'hidden' }}>
                    <aside className="w-64 bg-white border-r border-gray-200 flex flex-col h-full z-20 shadow-sm">
                        <div className="p-6 flex items-center gap-3 border-b border-gray-100">
                            <div className="bg-gradient-to-br from-fluent-blue to-fluent-blueHover text-white p-2.5 rounded-xl shadow-md">
                                <Icon name="layers" size={24} />
                            </div>
                            <h1 className="text-xl font-bold text-gray-800 tracking-tight">HabitFlow</h1>
                        </div>
                        <nav className="flex-1 px-4 py-4 space-y-1">
                            <button onClick={() => setTab('home')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-semibold transition-all duration-200 ${tab === 'home' ? 'bg-blue-50 text-fluent-blue shadow-sm' : 'text-gray-500 hover:bg-gray-50 hover:text-gray-900 active:scale-95'}`}>
                                <Icon name="home" size={20} /> Dashboard
                            </button>
                            <button onClick={() => setTab('activity')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-semibold transition-all duration-200 ${tab === 'activity' ? 'bg-blue-50 text-fluent-blue shadow-sm' : 'text-gray-500 hover:bg-gray-50 hover:text-gray-900 active:scale-95'}`}>
                                <Icon name="piechart" size={20} /> Analytics
                            </button>
                        </nav>
                        <div className="p-4 text-xs text-center text-gray-400 border-t border-gray-100">v2.3 Final</div>
                    </aside>
                    <main className="flex-1 flex flex-col h-full relative">
                        <header className="px-10 py-6 flex justify-between items-center bg-fluent-bg/80 backdrop-blur-md sticky top-0 z-10 border-b border-gray-200/50">
                            <div>
                                <h2 className="text-3xl font-bold text-gray-900">{tab === 'home' ? 'My Dashboard' : 'Analysis'}</h2>
                                <p className="text-gray-500 mt-1 font-medium">{new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}</p>
                            </div>
                            {tab === 'home' && (
                                <div className="flex gap-3">
                                    <button onClick={() => setIsGroupModalOpen(true)} className="flex items-center gap-2 bg-white text-gray-600 border border-gray-200 hover:bg-gray-50 hover:border-gray-300 px-4 py-2.5 rounded-xl shadow-sm hover:shadow-md transition-all duration-200 active:scale-95 font-semibold text-sm">
                                        <Icon name="folderPlus" size={18} />
                                        <span>Group</span>
                                    </button>
                                    <button onClick={() => setIsHabitModalOpen(true)} className="flex items-center gap-2 bg-fluent-blue hover:bg-fluent-blueHover text-white px-5 py-2.5 rounded-xl shadow-button-hover transition-all duration-200 active:scale-95 group font-bold text-sm">
                                        <Icon name="plus" size={18} strokeWidth={3} className="group-hover:rotate-90 transition-transform duration-300" />
                                        <span>New Habit</span>
                                    </button>
                                </div>
                            )}
                        </header>
                        <div className="flex-1 overflow-y-auto overflow-x-hidden px-10 pb-20 custom-scroll">
                            {tab === 'home' ? (
                                <div className="space-y-4 overflow-visible">
                                    {groupList.map(groupName => (
                                        <HabitGroupSection key={groupName} title={groupName} habits={habits.filter(h => (h.group || 'General') === groupName)} onLog={logHabit} onUndo={undoLog} onDropHabit={handleDropHabit} />
                                    ))}
                                    {habits.some(h => !groupList.includes(h.group || 'General')) && (
                                        <HabitGroupSection title="Uncategorized" habits={habits.filter(h => !groupList.includes(h.group || 'General'))} onLog={logHabit} onUndo={undoLog} onDropHabit={handleDropHabit} />
                                    )}
                                </div>
                            ) : (
                                <AnalyticsView habits={habits} />
                            )}
                        </div>
                    </main>
                    <AddHabitModal isOpen={isHabitModalOpen} onClose={() => setIsHabitModalOpen(false)} onAdd={addHabit} existingGroups={groupList} />
                    <AddGroupDialog isOpen={isGroupModalOpen} onClose={() => setIsGroupModalOpen(false)} onAdd={addGroup} />
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>