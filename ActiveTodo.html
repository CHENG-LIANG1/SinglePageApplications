<!DOCTYPE html>
<html lang="zh-CN" data-theme="ayu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iOS 26 Liquid Suite - Tasks v68 (ECharts)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

    <style>
        :root {
            --spring: cubic-bezier(0.32, 0.72, 0, 1);
            --ease-in-out: cubic-bezier(0.4, 0, 0.2, 1);
            --blur-strength: 60px;
        }

        /* --- THEMES --- */
        [data-theme="ayu"] { --bg-color: #0b0e14; --card-bg: rgba(31, 36, 48, 0.65); --text-primary: #e6e1cf; --text-secondary: rgba(255, 255, 255, 0.55); --glass-border: rgba(255, 180, 84, 0.15); --input-bg: rgba(20, 25, 30, 0.85); --accent-blue: #ffb454; --hm-bg: rgba(255,255,255,0.05); --accent-purple: #d2a6ff; --accent-red: #ff3333; --accent-green: #bae67e; --accent-orange: #ff8f40; }
        [data-theme="dracula"] { --bg-color: #20212c; --card-bg: rgba(40, 42, 54, 0.7); --text-primary: #f8f8f2; --text-secondary: #9eaec5; --glass-border: rgba(189, 147, 249, 0.2); --input-bg: rgba(68, 71, 90, 0.8); --accent-blue: #bd93f9; --hm-bg: rgba(255,255,255,0.05); --accent-purple: #ff79c6; --accent-red: #ff5555; --accent-green: #50fa7b; --accent-orange: #ffb86c; }
        [data-theme="monokai"] { --bg-color: #272822; --card-bg: rgba(39, 40, 34, 0.75); --text-primary: #f8f8f2; --text-secondary: #a5a4a1; --glass-border: rgba(253, 151, 31, 0.15); --input-bg: rgba(25, 25, 20, 0.9); --accent-blue: #fd971f; --hm-bg: rgba(255,255,255,0.05); --accent-purple: #ae81ff; --accent-red: #f92672; --accent-green: #a6e22e; --accent-orange: #e6db74; }
        [data-theme="onedark"] { --bg-color: #21252b; --card-bg: rgba(33, 37, 43, 0.75); --text-primary: #abb2bf; --text-secondary: #7c8491; --glass-border: rgba(97, 175, 239, 0.15); --input-bg: rgba(40, 44, 52, 0.9); --accent-blue: #61afef; --hm-bg: rgba(255,255,255,0.05); --accent-purple: #c678dd; --accent-red: #e06c75; --accent-green: #98c379; --accent-orange: #d19a66; }
        [data-theme="xcode"] { --bg-color: #18181b; --card-bg: rgba(44, 44, 48, 0.75); --text-primary: #ffffff; --text-secondary: #9999a0; --glass-border: rgba(255, 255, 255, 0.12); --input-bg: rgba(58, 58, 62, 0.9); --accent-blue: #0a84ff; --hm-bg: rgba(255,255,255,0.08); --accent-purple: #ac8e68; --accent-red: #ff453a; --accent-green: #32d74b; --accent-orange: #ff9f0a; }
        [data-theme="chiikawa"] { --bg-color: #fffafb; --card-bg: rgba(255, 255, 255, 0.85); --text-primary: #5d4037; --text-secondary: #8d6e63; --glass-border: rgba(118, 196, 234, 0.5); --input-bg: rgba(255, 250, 252, 1); --accent-blue: #76c4ea; --hm-bg: rgba(0,0,0,0.06); --accent-purple: #bd93f9; --accent-red: #e57373; --accent-green: #a5d6a7; --accent-orange: #ffd54f; }
        [data-theme="hellokitty"] { --bg-color: #fff0f5; --card-bg: rgba(255, 255, 255, 0.9); --text-primary: #212121; --text-secondary: #616161; --glass-border: rgba(255, 23, 68, 0.4); --input-bg: #ffffff; --accent-blue: #d50000; --hm-bg: rgba(0,0,0,0.06); --accent-purple: #f06292; --accent-red: #d50000; --accent-green: #00c853; --accent-orange: #ff9100; }
        [data-theme="christmas"] { --bg-color: #2a1b18; --card-bg: rgba(62, 39, 35, 0.85); --text-primary: #fff8e1; --text-secondary: rgba(255, 235, 238, 0.7); --glass-border: rgba(255, 82, 82, 0.3); --input-bg: rgba(45, 25, 25, 0.9); --accent-blue: #4caf50; --hm-bg: rgba(255,255,255,0.08); --accent-purple: #ffd700; --accent-red: #d32f2f; --accent-green: #388e3c; --accent-orange: #f57c00; }
        [data-theme="madoka"] { --bg-color: #fff1f8; --card-bg: rgba(255, 240, 245, 0.75); --text-primary: #880e4f; --text-secondary: #ad1457; --glass-border: rgba(255, 140, 180, 0.5); --input-bg: rgba(255, 255, 255, 0.9); --accent-blue: #ff4081; --hm-bg: rgba(255, 64, 129, 0.1); --accent-purple: #ba68c8; --accent-red: #ff1744; --accent-green: #69f0ae; --accent-orange: #ffd740; }
        [data-theme="frieren"] { --bg-color: #f1f8e9; --card-bg: rgba(255, 255, 255, 0.9); --text-primary: #263238; --text-secondary: #546e7a; --glass-border: rgba(67, 160, 71, 0.5); --input-bg: #ffffff; --accent-blue: #2e7d32; --hm-bg: rgba(0,0,0,0.06); --accent-purple: #ba68c8; --accent-red: #e53935; --accent-green: #2e7d32; --accent-orange: #fb8c00; }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-color); height: 100vh; width: 100vw;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; color: var(--text-primary);
            transition: background-color 0.4s ease;
            background-image: radial-gradient(at 0% 0%, rgba(255,255,255,0.03) 0, transparent 50%), 
                              radial-gradient(at 50% 100%, rgba(255,255,255,0.03) 0, transparent 50%);
        }

        .app-card {
            width: 94vw; max-width: 1100px; height: 90vh; max-height: 920px;
            background: var(--card-bg); backdrop-filter: blur(var(--blur-strength)) saturate(180%);
            border-radius: 28px; border: 1px solid var(--glass-border);
            box-shadow: 0 40px 100px rgba(0,0,0,0.2), inset 0 0 0 1px rgba(255,255,255,0.05);
            position: relative; display: flex; flex-direction: column; overflow: hidden; z-index: 10;
            transition: background 0.3s ease, border-color 0.3s ease;
        }

        .modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(8px); opacity: 0; pointer-events: none; transition: 0.2s ease; z-index: 40; }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .view-container { flex: 1; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        
        .header { padding: 32px 40px 20px 40px; z-index: 20; flex-shrink: 0; display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 1px solid var(--glass-border); }
        .header-left { display: flex; flex-direction: column; }
        .header-subtitle { font-size: 13px; color: var(--accent-blue); font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 2px; }
        .header h1 { font-size: 36px; font-weight: 700; letter-spacing: -0.5px; color: var(--text-primary); line-height: 1.1; outline: none; border-bottom: 2px solid transparent; cursor: text; transition: 0.2s; }
        .header h1:hover { border-bottom-color: var(--glass-border); }
        .header h1:focus { border-bottom-color: var(--accent-blue); }

        .header-controls { display: flex; gap: 10px; align-items: center; }
        .search-bar { display: flex; align-items: center; background: rgba(125,125,125,0.1); border-radius: 12px; padding: 0 12px; height: 40px; transition: 0.2s ease; width: 180px; border: 1px solid transparent; }
        .search-bar:focus-within { background: rgba(125,125,125,0.15); width: 220px; border-color: var(--glass-border); }
        .search-input { flex: 1; background: transparent; border: none; color: var(--text-primary); font-size: 15px; outline: none; margin-left: 8px; }
        .search-icon { color: var(--text-secondary); width: 16px; height: 16px; }
        .header-btn { height: 40px; padding: 0 14px; border-radius: 12px; border: 1px solid transparent; background: rgba(125,125,125,0.1); color: var(--text-secondary); display: flex; align-items: center; justify-content: center; gap: 6px; cursor: pointer; transition: 0.2s ease; font-size: 14px; font-weight: 500; }
        .header-btn:hover { background: rgba(125,125,125,0.2); color: var(--text-primary); border-color: var(--glass-border); }
        .header-btn.active { background: var(--accent-blue); color: var(--bg-color); box-shadow: 0 0 15px rgba(0,0,0,0.1); }
        .header-btn svg { width: 18px; height: 18px; }

        .scroll-content { flex: 1; overflow-y: auto; padding: 24px 40px 140px 40px; scrollbar-width: thin; }
        .scroll-content::-webkit-scrollbar { width: 4px; }
        .scroll-content::-webkit-scrollbar-thumb { background: var(--glass-border); border-radius: 2px; }
        .empty-state { display: none; flex-direction: column; align-items: center; text-align: center; color: var(--text-secondary); margin-top: 100px; opacity: 0.5; }
        .empty-icon-wrapper { font-size: 64px; margin-bottom: 16px; }

        /* ACTIVITY VIEW */
        .activity-view { display: none; flex-direction: column; gap: 32px; animation: fadeIn 0.3s ease; }
        .activity-view.active { display: flex; }
        .act-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .act-title { font-size: 18px; font-weight: 700; color: var(--text-primary); }
        
        /* UNIFIED ACTIVITY CONTROLS (v68: Height 32px, Radius, etc.) */
        .act-control-item {
            height: 32px; 
            background: rgba(125,125,125,0.1); 
            border-radius: 8px; /* Consistent Radius */
            display: flex; align-items: center; justify-content: center;
            padding: 0 12px; 
            font-size: 13px; font-weight: 600; 
            color: var(--text-secondary);
            border: 1px solid transparent;
            transition: 0.2s;
        }
        .act-control-item:hover { background: rgba(125,125,125,0.2); color: var(--text-primary); }
        .act-control-item.highlight { color: var(--accent-blue); } /* For Total Count */
        
        /* HEATMAP */
        .heatmap-container { 
            width: 100%; margin-top: 0; 
            border: 1px solid var(--glass-border); border-radius: 20px; 
            padding: 24px; background: rgba(125,125,125,0.03);
            display: flex; flex-direction: column;
        }
        .heatmap-wrapper { overflow-x: auto; padding-bottom: 10px; width: 100%; }
        .heatmap-wrapper::-webkit-scrollbar { height: 6px; }
        .heatmap-wrapper::-webkit-scrollbar-thumb { background: var(--glass-border); border-radius: 3px; }
        
        .heatmap-grid { 
            display: grid; 
            grid-template-rows: repeat(7, 1fr); 
            grid-template-columns: repeat(53, 1fr); 
            gap: 3px; 
            width: 100%;
            padding: 4px; 
        }
        .hm-cell { 
            aspect-ratio: 1; border-radius: 2px; 
            background: var(--hm-bg); transition: 0.1s; 
        }
        /* v68: Removed Box Shadow for cleaner look */
        .hm-l1 { background: var(--accent-blue); opacity: 0.3; } 
        .hm-l2 { background: var(--accent-blue); opacity: 0.5; } 
        .hm-l3 { background: var(--accent-blue); opacity: 0.7; } 
        .hm-l4 { background: var(--accent-blue); opacity: 1; }

        .heatmap-months {
            display: grid; grid-template-columns: repeat(12, 1fr);
            margin-top: 8px; width: 100%;
        }
        .hm-month-label { font-size: 10px; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; text-align: left; }

        /* GLOBAL TOOLTIP */
        #globalTooltip {
            position: fixed; top: 0; left: 0;
            background: var(--input-bg); border: 1px solid var(--glass-border);
            padding: 8px 12px; border-radius: 8px; 
            font-size: 11px; color: var(--text-primary);
            pointer-events: none; opacity: 0; z-index: 10000;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
            transition: opacity 0.15s ease;
            backdrop-filter: blur(10px);
        }
        #globalTooltip.visible { opacity: 1; }

        /* CHART (ECHARTS) */
        .chart-container { background: rgba(125,125,125,0.03); border: 1px solid var(--glass-border); border-radius: 20px; padding: 24px; position: relative; min-height: 350px; height: 350px; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .chart-title { font-size: 14px; font-weight: 600; color: var(--text-secondary); }
        .chart-toggle { height: 32px; background: rgba(125,125,125,0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center; padding: 0 12px; font-size: 13px; font-weight: 600; color: var(--text-secondary); border: 1px solid transparent; transition: 0.2s; cursor: pointer; gap: 6px; }
        .chart-toggle:hover { background: rgba(125,125,125,0.2); color: var(--text-primary); }
        .chart-toggle svg { width: 14px; height: 14px; }

        /* LIST VIEW */
        .section-container {
            display: grid; grid-template-rows: 0fr; transition: grid-template-rows 0.5s var(--spring), opacity 0.4s ease, margin-bottom 0.5s var(--spring), padding-bottom 0.5s var(--spring), border-color 0.4s ease;
            opacity: 0; margin-bottom: 0; padding-bottom: 0; border-bottom: 1px solid transparent;
        }
        .section-container.active { grid-template-rows: 1fr; opacity: 1; margin-bottom: 24px; padding-bottom: 12px; border-bottom-color: var(--glass-border); }
        .section-inner { overflow: hidden; min-height: 0; }
        .section-title { font-size: 12px; font-weight: 700; color: var(--accent-blue); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 12px; display: flex; align-items: center; gap: 6px; opacity: 0.9; }

        .todo-item {
            background: rgba(125,125,125,0.05); margin-bottom: 8px; padding: 18px 24px;
            border-radius: 16px; display: flex; align-items: flex-start; 
            border: 1px solid var(--glass-border); 
            transition: opacity 0.4s var(--ease-in-out), transform 0.4s var(--spring), max-height 0.4s var(--ease-in-out), margin-bottom 0.4s var(--ease-in-out), padding 0.4s var(--ease-in-out), border 0.4s;
            min-height: 56px; opacity: 1; transform: translateX(0); max-height: 200px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden;
        }
        .todo-item.pinned { background: rgba(125,125,125,0.08); border-color: var(--accent-blue); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .slide-out-right { transform: translateX(100px); opacity: 0; max-height: 0; margin-bottom: 0; padding-top: 0; padding-bottom: 0; border-width: 0; pointer-events: none; }
        .slide-out-left { transform: translateX(-100px); opacity: 0; max-height: 0; margin-bottom: 0; padding-top: 0; padding-bottom: 0; border-width: 0; pointer-events: none; }
        .todo-item:hover { background: rgba(125,125,125,0.08); border-color: var(--text-secondary); }
        
        .custom-checkbox { width: 24px; height: 24px; border: 2px solid var(--text-secondary); border-radius: 8px; margin-right: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; margin-top: 3px; transition: background 0.3s var(--spring), border-color 0.3s, transform 0.2s; opacity: 0.6; }
        .todo-item:hover .custom-checkbox { opacity: 1; }
        .custom-checkbox svg { width: 16px; height: 16px; stroke-width: 3px; color: var(--bg-color); stroke-dasharray: 24; stroke-dashoffset: 24; transition: stroke-dashoffset 0.4s cubic-bezier(0.65, 0, 0.45, 1); }
        
        .todo-item.completed .custom-checkbox { background: var(--accent-blue); border-color: var(--accent-blue); transform: scale(1.05); opacity: 1; }
        .todo-item.completed .custom-checkbox svg { stroke-dashoffset: 0; }
        .todo-item.completed .todo-text { text-decoration: line-through; color: var(--text-secondary); opacity: 0.6; transition: opacity 0.3s; font-size: 16px; }
        .todo-item.recurring-done .todo-text { text-decoration: line-through; color: var(--text-secondary); opacity: 0.6; font-size: 16px; }
        .todo-item.recurring-done .custom-checkbox { opacity: 0.8; }

        .view-archived .custom-checkbox { display: none; }
        .view-archived .todo-item { padding-left: 24px; border-left: 4px solid var(--glass-border); } 
        .view-archived .todo-text { text-decoration: line-through; color: var(--text-secondary); opacity: 0.6; font-size: 16px; }

        .todo-content { flex: 1; display: flex; flex-direction: column; gap: 6px; justify-content: center; min-width: 0; cursor: pointer; }
        .todo-text { font-size: 16px; color: var(--text-primary); font-weight: 400; line-height: 1.6; }
        .todo-meta { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-top: 2px; }
        .deadline-badge { display: inline-flex; align-items: center; gap: 5px; font-size: 11px; font-weight: 500; color: var(--text-secondary); height: 24px; padding: 0 8px; border-radius: 6px; border: 1px solid var(--glass-border); background: rgba(125,125,125,0.05); }
        .deadline-badge.p-critical { color: var(--accent-red); border-color: rgba(255, 69, 58, 0.3); background: rgba(255, 69, 58, 0.1); }
        .deadline-badge.p-high { color: var(--accent-orange); border-color: rgba(255, 159, 10, 0.3); background: rgba(255, 159, 10, 0.1); }
        .deadline-badge.p-medium { color: var(--accent-blue); border-color: rgba(10, 132, 255, 0.3); background: rgba(10, 132, 255, 0.1); }
        .deadline-badge.repeat { border-color: var(--accent-purple); color: var(--accent-purple); background: rgba(191, 90, 242, 0.1); }
        .deadline-badge.reset-prompt { border-color: var(--accent-green); color: var(--accent-green); background: rgba(50, 215, 75, 0.1); }

        .item-actions { opacity: 0; display: flex; align-items: center; gap: 6px; margin-left: 12px; margin-top: 2px; transition: 0.2s; }
        .todo-item:hover .item-actions { opacity: 1; }
        .icon-btn { background: transparent; border: none; color: var(--text-secondary); cursor: pointer; padding: 0; width: 28px; height: 28px; border-radius: 8px; transition: 0.15s; display: flex; align-items: center; justify-content: center; }
        .icon-btn svg { width: 14px; height: 14px; }
        .icon-btn:hover { background: rgba(125,125,125,0.2); color: var(--text-primary); }
        .icon-btn.archive:hover { background: rgba(159, 90, 253, 0.15); color: var(--accent-purple); }
        .icon-btn.unarchive:hover { background: rgba(41, 151, 255, 0.15); color: var(--accent-blue); }
        .icon-btn.delete:hover { background: rgba(255, 69, 58, 0.15); color: var(--accent-red); }
        .icon-btn.pin:hover { background: rgba(255, 159, 10, 0.15); color: var(--accent-orange); }

        /* FLOATING INPUT */
        .floating-input-container { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); width: 70%; max-width: 700px; z-index: 50; transition: all 0.4s var(--spring); }
        .input-hidden { transform: translateX(-50%) translateY(200%); opacity: 0; pointer-events: none; }
        .floating-input-container.expanded { bottom: 50%; left: 50%; transform: translate(-50%, 50%); width: 80%; max-width: 800px; height: auto; min-height: 320px; }
        .input-capsule { width: 100%; min-height: 56px; height: auto; background: var(--input-bg); backdrop-filter: blur(40px); border-radius: 28px; display: flex; align-items: flex-end; padding: 8px 8px 8px 16px; border: 1px solid var(--glass-border); box-shadow: 0 25px 70px rgba(0,0,0,0.3); transition: 0.3s var(--spring); position: relative; flex-direction: row; }
        .input-left-controls { display: flex; gap: 8px; margin-bottom: 7px; margin-right: 12px; align-items: center; flex-shrink: 0; }
        .meta-trigger { background: rgba(125,125,125,0.1); color: var(--text-secondary); border-radius: 12px; padding: 4px 10px; font-size: 12px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 4px; height: 30px; transition: 0.15s; }
        .meta-trigger:hover, .meta-trigger.active { background: var(--accent-blue); color: var(--bg-color); }
        .meta-trigger svg { width: 13px; height: 13px; } 
        .expand-btn { background: transparent; border: 1px solid rgba(125,125,125,0.2); color: var(--text-secondary); border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.15s; }
        .expand-btn:hover { background: rgba(125,125,125,0.3); color: var(--text-primary); }
        .expand-btn svg { width: 12px; height: 12px; }
        .text-input { flex: 1; background: transparent; border: none; color: var(--text-primary); font-size: 16px; outline: none; font-weight: 400; resize: none; overflow: hidden; min-height: 24px; max-height: 140px; line-height: 1.5; padding: 10px 0; margin-right: 10px; width: 100%; transition: padding 0.2s ease, margin 0.2s ease; }
        .action-btn { width: 44px; height: 44px; border-radius: 50%; border: none; background: var(--accent-blue); color: var(--bg-color); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s var(--spring); flex-shrink: 0; }
        .action-btn:hover { transform: scale(1.1); filter: brightness(1.1); }
        .floating-input-container.expanded .input-capsule { flex-direction: column; align-items: flex-start; padding: 28px; background: var(--card-bg); border-radius: 36px; box-shadow: 0 50px 120px rgba(0,0,0,0.5); }
        .floating-input-container.expanded .input-left-controls { width: 100%; justify-content: flex-start; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--glass-border); }
        .floating-input-container.expanded .text-input { font-size: 16px; max-height: none; min-height: 150px; overflow-y: auto; padding: 0; margin: 0; scrollbar-width: thin; scrollbar-color: rgba(125,125,125,0.2) transparent; }
        .floating-input-container.expanded .action-btn { position: absolute; bottom: 28px; right: 28px; width: 64px; height: 64px; background: var(--accent-blue); color: var(--bg-color); box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 60; }
        .recurrence-options { display: none; width: 100%; gap: 6px; margin-bottom: 20px; }
        .floating-input-container.expanded .recurrence-options { display: flex; flex-wrap: wrap; }
        .recur-btn { background: rgba(125,125,125,0.05); border: 1px solid rgba(125,125,125,0.1); color: var(--text-secondary); border-radius: 10px; padding: 6px 10px; font-size: 11px; font-weight: 600; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 4px; }
        .recur-btn:hover { background: rgba(125,125,125,0.15); color: var(--text-primary); }
        .recur-btn.active { background: var(--accent-orange); color: #fff; border-color: var(--accent-orange); }
        .recur-btn svg { width: 12px; height: 12px; }
        .markdown-toolbar { display: none; width: 100%; padding-top: 10px; gap: 8px; }
        .floating-input-container.expanded .markdown-toolbar { display: flex; flex-wrap: wrap; padding-right: 80px; }
        .md-tool-btn { background: rgba(125,125,125,0.08); border: none; color: var(--text-secondary); border-radius: 8px; padding: 6px 12px; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 6px; height: 32px; }
        .md-tool-btn:hover { background: rgba(125,125,125,0.15); color: var(--text-primary); }

        /* THEME PICKER */
        #themeModal { width: 680px; max-width: 90vw; }
        .theme-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 16px; padding: 24px; overflow-y: auto; flex: 1; min-height: 0; scrollbar-width: thin; }
        .theme-card { background: rgba(125,125,125,0.05); border-radius: 18px; padding: 16px; cursor: pointer; transition: 0.2s var(--spring); border: 2px solid transparent; display: flex; flex-direction: column; gap: 12px; }
        .theme-card:hover { transform: translateY(-4px); background: rgba(125,125,125,0.1); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .theme-card.selected { border-color: var(--accent-blue); background: rgba(125,125,125,0.15); }
        .preview-box { height: 80px; border-radius: 12px; width: 100%; position: relative; padding: 12px; display: flex; flex-direction: column; gap: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden; pointer-events: none; }
        .mini-header { height: 8px; width: 40%; background: currentColor; opacity: 0.8; border-radius: 4px; margin-bottom: 6px; }
        .mini-row { height: 6px; width: 100%; background: currentColor; opacity: 0.15; border-radius: 3px; }
        .mini-row.short { width: 70%; }
        .mini-fab { position: absolute; bottom: 10px; right: 10px; width: 20px; height: 20px; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .theme-info { display: flex; justify-content: space-between; align-items: center; padding: 0 4px; }
        .theme-name { font-size: 14px; font-weight: 600; color: var(--text-primary); }
        .selected-icon { width: 20px; height: 20px; background: var(--accent-blue); color: var(--bg-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; opacity: 0; transform: scale(0.5); transition: 0.2s var(--spring); }
        .theme-card.selected .selected-icon { opacity: 1; transform: scale(1); }
        .selected-icon svg { width: 12px; height: 12px; stroke-width: 4px; }

        /* MODALS & POPUPS */
        .glass-popup { position: absolute; bottom: 65px; left: 0; background: var(--card-bg); backdrop-filter: blur(40px); border-radius: 20px; border: 1px solid var(--glass-border); box-shadow: 0 30px 80px rgba(0,0,0,0.3); opacity: 0; pointer-events: none; transform: translateY(20px) scale(0.95); transition: 0.2s; z-index: 100; width: 280px; padding: 16px; }
        .glass-popup.open { opacity: 1; pointer-events: all; transform: translateY(0) scale(1); }
        .floating-input-container.expanded .glass-popup { bottom: auto; top: 70px; left: 24px; }
        .dp-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .dp-nav { background: rgba(125,125,125,0.1); border: none; color: var(--text-primary); border-radius: 8px; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .dp-day-names { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; margin-bottom: 8px; }
        .dp-day-name { font-size: 11px; color: var(--text-secondary); font-weight: 600; }
        .dp-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .dp-cell { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 13px; border-radius: 6px; cursor: pointer; color: var(--text-primary); }
        .dp-cell:hover { background: rgba(125,125,125,0.1); }
        .dp-cell.selected { background: var(--accent-blue); color: var(--bg-color); font-weight: 600; }
        .dp-cell.is-today { font-weight: 800; color: var(--accent-blue); position: relative; }
        .dp-cell.is-today::after { content: ''; position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; border-radius: 50%; background: var(--accent-blue); }

        .detail-modal { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -40%) scale(0.95); width: 85%; max-width: 550px; max-height: 80vh; background: var(--card-bg); backdrop-filter: blur(50px); border-radius: 32px; border: 1px solid var(--glass-border); box-shadow: 0 50px 150px rgba(0,0,0,0.5); z-index: 200; opacity: 0; pointer-events: none; display: flex; flex-direction: column; transition: 0.25s var(--spring); }
        .detail-modal.open { opacity: 1; pointer-events: all; transform: translate(-50%, -50%) scale(1); }
        .detail-content { padding: 36px; overflow-y: auto; flex: 1; }
        .detail-text { font-size: 18px; line-height: 1.6; color: var(--text-primary); margin-bottom: 24px; word-break: break-word; }
        .detail-footer { padding: 16px 36px; border-top: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; background: rgba(125,125,125,0.05); }
        .detail-meta { color: var(--text-secondary); font-size: 13px; font-weight: 500; }
        .detail-actions { display: flex; gap: 10px; }
        .detail-icon-btn { width: 36px; height: 36px; border-radius: 10px; border: none; background: transparent; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; padding: 0; color: var(--text-secondary); }
        .detail-icon-btn svg { width: 18px; height: 18px; } 
        .detail-icon-btn:hover { background: rgba(125,125,125,0.1); color: var(--text-primary); }
        
        /* MONTHLY CALENDAR GRID (FULL VIEW) */
        #calendarModal { max-width: 900px; width: 90vw; height: 85vh; max-height: 85%; }
        #calendarModal .detail-content { padding: 0; height: 100%; display: flex; flex-direction: column; }
        .year-scroll-container { 
            flex: 1; overflow-y: auto; padding: 24px; 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 24px;
        }
        @media (max-width: 768px) { .year-scroll-container { grid-template-columns: 1fr; } } 

        .single-month-card { 
            background: rgba(125,125,125,0.03); 
            border: 1px solid var(--glass-border); 
            border-radius: 16px; padding: 16px 12px; 
            display: flex; flex-direction: column; 
        }
        .sm-header { font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--text-primary); text-align: center; }
        .sm-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; }
        .sm-cell { 
            aspect-ratio: 1; border-radius: 4px; position: relative;
            background: var(--hm-bg); transition: 0.1s;
            min-width: 0; /* Allow cells to shrink */
        }
        /* v68 Fix: Hover using outline instead of border to prevent layout shift */
        .sm-cell:hover { transform: scale(1.1); z-index: 10; outline: 1px solid var(--text-primary); }
        
        .sm-l1 { background: var(--accent-blue); opacity: 0.3; } 
        .sm-l2 { background: var(--accent-blue); opacity: 0.6; } 
        /* v68 Fix: Removed Box Shadow for cleaner look */
        .sm-l3 { background: var(--accent-blue); opacity: 1; z-index:2; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="background-mesh"></div>

    <div id="globalTooltip"></div>

    <div class="app-card" id="appCard">
        <div class="modal-overlay" id="modalOverlay" onclick="window.closeOverlays()"></div>

        <div class="detail-modal" id="themeModal">
            <div style="padding: 24px 30px; border-bottom: 1px solid var(--glass-border); display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0; font-size:18px; color:var(--text-primary); font-weight:600;">Appearance</h3>
                <button class="detail-icon-btn" onclick="window.closeThemePicker()"><i data-lucide="x"></i></button>
            </div>
            <div class="theme-grid" id="themeGrid"></div>
        </div>

        <div class="detail-modal" id="calendarModal">
             <div style="padding: 24px 30px; border-bottom: 1px solid var(--glass-border); display:flex; justify-content:space-between; align-items:center;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <button class="detail-icon-btn" onclick="window.changeFullCalendarYear(-1)"><i data-lucide="chevron-left"></i></button>
                    <h3 id="fullCalTitle" style="margin:0; font-size:18px; color:var(--text-primary); font-weight:700;">2026 Details</h3>
                    <button class="detail-icon-btn" onclick="window.changeFullCalendarYear(1)"><i data-lucide="chevron-right"></i></button>
                </div>
                <button class="detail-icon-btn" onclick="window.closeCalendarModal()"><i data-lucide="x"></i></button>
            </div>
            <div class="detail-content">
                <div id="yearScrollContainer" class="year-scroll-container">
                    </div>
            </div>
        </div>

        <div class="detail-modal" id="trashModal" style="max-width: 600px;">
             <div style="padding: 24px 30px; border-bottom: 1px solid var(--glass-border); display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0; font-size:18px; color:var(--text-primary); font-weight:600;">Trash Bin</h3>
                <button class="detail-icon-btn" onclick="window.closeTrash()"><i data-lucide="x"></i></button>
            </div>
            <div class="detail-content" id="trashList" style="padding: 20px; max-height: 30vh; overflow-y: auto;"></div>
            <div class="detail-footer" style="justify-content: flex-end;">
                 <button class="detail-icon-btn" style="color:var(--accent-red); width:auto; padding:0 12px; gap:6px;" onclick="window.emptyTrash()">
                    <i data-lucide="trash-2"></i> Empty Trash
                 </button>
            </div>
        </div>

        <div class="detail-modal" id="detailModal">
            <div class="detail-content" id="detailContent"></div>
            <div class="detail-footer">
                <div class="detail-meta" id="detailMeta"></div>
                <div class="detail-actions" id="detailActions"></div>
            </div>
        </div>

        <div class="view-container" id="viewContainer">
            <div class="header">
                <div class="header-left">
                    <div class="header-subtitle" id="dateDisplay">DATE</div>
                    <h1 id="appTitle" contenteditable="true" spellcheck="false" onblur="window.saveTitle(this.innerText)">Tasks</h1>
                </div>
                <div class="header-controls">
                    <div class="search-bar">
                        <i data-lucide="search" class="search-icon"></i>
                        <input type="text" class="search-input" id="searchInput" placeholder="Search" autocomplete="off">
                    </div>
                    <button class="header-btn" id="themeBtn" onclick="window.openThemePicker()" title="Theme">
                        <i data-lucide="palette"></i>
                    </button>
                    <button class="header-btn" onclick="window.openTrash()" title="Trash">
                        <i data-lucide="trash"></i>
                    </button>
                    <button class="header-btn" id="toggleArchived" onclick="window.toggleShowArchived()" title="Archive">
                        <i data-lucide="archive"></i>
                    </button>
                    <button class="header-btn" id="btnActivity" onclick="window.toggleActivityView()" title="Activity">
                        <i data-lucide="flame"></i>
                    </button>
                </div>
            </div>

            <div class="scroll-content" id="todoScrollArea">
                
                <div id="activityView" class="activity-view">
                    <div class="act-header">
                        <div class="act-title">Activity Dashboard</div>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <div class="act-control-item highlight" id="totalCompletedDisplay">0 Completed</div>
                            <div class="act-control-item" style="gap:10px; padding:0 6px;">
                                <button onclick="window.changeHeatmapYear(-1)" style="background:none; border:none; color:inherit; cursor:pointer; display:flex;"><i data-lucide="chevron-left" style="width:14px;"></i></button>
                                <span id="heatmapYear" style="font-variant-numeric: tabular-nums;">2026</span>
                                <button onclick="window.changeHeatmapYear(1)" style="background:none; border:none; color:inherit; cursor:pointer; display:flex;"><i data-lucide="chevron-right" style="width:14px;"></i></button>
                            </div>
                            <button class="act-control-item" onclick="window.openCalendarModal()" title="Full Year Calendar" style="cursor:pointer;">
                                <i data-lucide="calendar" style="width:16px;"></i>
                            </button>
                        </div>
                    </div>

                    <div class="heatmap-container">
                        <div class="heatmap-wrapper">
                            <div class="heatmap-grid" id="heatmapGrid"></div>
                            <div class="heatmap-months">
                                 <span class="hm-month-label">Jan</span><span class="hm-month-label">Feb</span><span class="hm-month-label">Mar</span><span class="hm-month-label">Apr</span><span class="hm-month-label">May</span><span class="hm-month-label">Jun</span><span class="hm-month-label">Jul</span><span class="hm-month-label">Aug</span><span class="hm-month-label">Sep</span><span class="hm-month-label">Oct</span><span class="hm-month-label">Nov</span><span class="hm-month-label">Dec</span>
                            </div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-header">
                            <span class="chart-title">Monthly Trend</span>
                            <button class="chart-toggle" onclick="window.toggleChartType()">
                                <i data-lucide="bar-chart-2" id="chartIcon"></i>
                                <span id="chartLabel">Switch to Bar</span>
                            </button>
                        </div>
                        <div id="activityChart" style="width:100%; height:300px;"></div>
                    </div>
                </div>

                <div id="listView">
                    <div id="pinnedContainer" class="section-container">
                        <div class="section-inner">
                            <div class="section-title"><i data-lucide="pin" style="width:12px;"></i> Pinned</div>
                            <div id="pinnedList"></div>
                        </div>
                    </div>

                    <div id="todoList"></div>
                    <div class="empty-state" id="emptyTodo">
                        <div class="empty-icon-wrapper"><i data-lucide="check-circle-2"></i></div>
                        <p id="emptyTodoText">All caught up.</p>
                    </div>
                </div>

            </div>

            <div class="floating-input-container" id="inputContainer">
                <div class="glass-popup" id="taskDatePicker">
                    <div class="dp-header">
                        <button class="dp-nav" onclick="window.changeTaskMonth(-1)"><i data-lucide="chevron-left" style="width:16px;"></i></button>
                        <span style="font-weight:600; font-size:15px;" id="dpTitle">Month</span>
                        <button class="dp-nav" onclick="window.changeTaskMonth(1)"><i data-lucide="chevron-right" style="width:16px;"></i></button>
                    </div>
                    <div class="dp-day-names">
                        <span class="dp-day-name">Su</span><span class="dp-day-name">Mo</span><span class="dp-day-name">Tu</span><span class="dp-day-name">We</span><span class="dp-day-name">Th</span><span class="dp-day-name">Fr</span><span class="dp-day-name">Sa</span>
                    </div>
                    <div class="dp-grid" id="dpGrid"></div>
                </div>

                <div class="input-capsule">
                    <div class="input-left-controls">
                        <div class="meta-trigger" id="taskDateTrigger" onclick="window.toggleTaskDatePicker()">
                            <i data-lucide="calendar"></i>
                            <span id="taskDateDisplay">Due</span>
                        </div>
                        <div class="meta-trigger" id="taskRecurTrigger" onclick="window.cycleRecurrence()">
                            <i data-lucide="rotate-cw"></i>
                            <span id="taskRecurDisplay">Repeat</span>
                        </div>
                        <button class="expand-btn" id="expandBtn" onclick="window.toggleExpand()">
                            <i data-lucide="maximize-2"></i>
                        </button>
                    </div>

                    <textarea class="text-input" id="todoInput" placeholder="New Task..." rows="1"></textarea>
                    
                    <div class="recurrence-options">
                        <button class="recur-btn active" id="recurNone" onclick="window.setRecurrence('none')">No Repeat</button>
                        <button class="recur-btn" id="recurDaily" onclick="window.setRecurrence('daily')"><i data-lucide="rotate-cw"></i> Daily</button>
                        <button class="recur-btn" id="recurWork" onclick="window.setRecurrence('workdays')"><i data-lucide="briefcase"></i> Workdays</button>
                        <button class="recur-btn" id="recurWeekly" onclick="window.setRecurrence('weekly')"><i data-lucide="calendar-days"></i> Weekly</button>
                        <button class="recur-btn" id="recurMonthly" onclick="window.setRecurrence('monthly')"><i data-lucide="calendar"></i> Monthly</button>
                        <button class="recur-btn" id="recurYearly" onclick="window.setRecurrence('yearly')"><i data-lucide="calendar-clock"></i> Yearly</button>
                    </div>

                    <div class="markdown-toolbar">
                        <button class="md-tool-btn" onclick="window.insertMarkdown('**', '**')"><i data-lucide="bold" style="width:14px;"></i></button>
                        <button class="md-tool-btn" onclick="window.insertMarkdown('*', '*')"><i data-lucide="italic" style="width:14px;"></i></button>
                        <button class="md-tool-btn" onclick="window.insertMarkdown('\n- ', '')"><i data-lucide="list" style="width:14px;"></i></button>
                        <button class="md-tool-btn" onclick="window.insertMarkdown('## ', '')"><i data-lucide="heading" style="width:14px;"></i></button>
                        <button class="md-tool-btn" onclick="window.insertMarkdown('`', '`')"><i data-lucide="code" style="width:14px;"></i></button>
                        <button class="md-tool-btn" onclick="window.insertMarkdown('\n> ', '')"><i data-lucide="quote" style="width:14px;"></i></button>
                    </div>

                    <button class="action-btn" id="actionBtn" onclick="window.addTodo()">
                        <i data-lucide="arrow-up" style="width:24px;" id="actionIcon"></i>
                    </button>
                </div>
            </div>

        </div>

    </div>

    <script>
        lucide.createIcons();
        const MASTER_KEY = 'ios26_liquid_tasks_master';
        const CONFIG_KEY = 'ios26_liquid_config';
        function migrateOldData() { if (!localStorage.getItem(MASTER_KEY)) { const v10 = localStorage.getItem('ios26_todos_v10'); if (v10) localStorage.setItem(MASTER_KEY, v10); } }
        migrateOldData();

        let todos = JSON.parse(localStorage.getItem(MASTER_KEY)) || [];
        let config = JSON.parse(localStorage.getItem(CONFIG_KEY)) || { title: 'Tasks', theme: 'ayu' };
        
        let searchTerm = ''; 
        let showArchived = false;
        let isActivityView = false;
        let chartType = 'line'; 
        let fullCalendarYear = new Date().getFullYear();
        let myChart = null; // ECharts instance
        
        let newTaskDate = null;
        let pickerCurrentDate = new Date(); 
        let isExpanded = false;
        let editingTaskId = null;
        let newRecurrence = 'none';
        let currentHeatmapYear = new Date().getFullYear();

        const THEMES = [
            { id: 'ayu', name: 'Ayu', bg:'#0b0e14', text:'#e6e1cf', acc:'#ffb454' },
            { id: 'dracula', name: 'Dracula', bg:'#20212c', text:'#f8f8f2', acc:'#bd93f9' },
            { id: 'monokai', name: 'Monokai', bg:'#272822', text:'#f8f8f2', acc:'#fd971f' },
            { id: 'onedark', name: 'One Dark', bg:'#21252b', text:'#e6e6e6', acc:'#61afef' },
            { id: 'xcode', name: 'Xcode', bg:'#18181b', text:'#ffffff', acc:'#0a84ff' },
            { id: 'chiikawa', name: 'Chiikawa', bg:'#fffafb', text:'#5d4037', acc:'#76c4ea' },
            { id: 'hellokitty', name: 'Hello Kitty', bg:'#fff0f5', text:'#212121', acc:'#d50000' },
            { id: 'christmas', name: 'Christmas', bg:'#2a1b18', text:'#fff8e1', acc:'#4caf50' },
            { id: 'madoka', name: 'Madoka', bg:'#fff1f8', text:'#880e4f', acc:'#ff4081' },
            { id: 'frieren', name: 'Frieren', bg:'#f1f8e9', text:'#263238', acc:'#2e7d32' }
        ];

        document.documentElement.setAttribute('data-theme', config.theme);
        document.getElementById('appTitle').innerText = config.title;

        const els = {
            viewContainer: document.getElementById('viewContainer'),
            listView: document.getElementById('listView'),
            activityView: document.getElementById('activityView'),
            todoList: document.getElementById('todoList'),
            pinnedList: document.getElementById('pinnedList'),
            pinnedContainer: document.getElementById('pinnedContainer'),
            todoInput: document.getElementById('todoInput'),
            inputContainer: document.getElementById('inputContainer'),
            expandBtn: document.getElementById('expandBtn'),
            expandIcon: document.getElementById('expandIcon'),
            modalOverlay: document.getElementById('modalOverlay'),
            detailModal: document.getElementById('detailModal'),
            detailContent: document.getElementById('detailContent'),
            detailMeta: document.getElementById('detailMeta'),
            detailActions: document.getElementById('detailActions'),
            taskDatePicker: document.getElementById('taskDatePicker'),
            taskDateTrigger: document.getElementById('taskDateTrigger'),
            taskDateDisplay: document.getElementById('taskDateDisplay'),
            taskRecurTrigger: document.getElementById('taskRecurTrigger'), 
            taskRecurDisplay: document.getElementById('taskRecurDisplay'), 
            dpTitle: document.getElementById('dpTitle'),
            dpGrid: document.getElementById('dpGrid'),
            searchInput: document.getElementById('searchInput'),
            toggleArchived: document.getElementById('toggleArchived'),
            btnActivity: document.getElementById('btnActivity'),
            emptyTodo: document.getElementById('emptyTodo'),
            emptyTodoText: document.getElementById('emptyTodoText'),
            actionBtn: document.getElementById('actionBtn'),
            actionIcon: document.getElementById('actionIcon'),
            heatmapGrid: document.getElementById('heatmapGrid'),
            heatmapYear: document.getElementById('heatmapYear'),
            themeModal: document.getElementById('themeModal'),
            themeGrid: document.getElementById('themeGrid'),
            trashModal: document.getElementById('trashModal'),
            trashList: document.getElementById('trashList'),
            activityChart: document.getElementById('activityChart'),
            calendarModal: document.getElementById('calendarModal'),
            yearScrollContainer: document.getElementById('yearScrollContainer'),
            fullCalTitle: document.getElementById('fullCalTitle'),
            globalTooltip: document.getElementById('globalTooltip')
        };

        function attemptDataRecovery() {
            const keysToCheck = [MASTER_KEY, 'ios26_todos_v10', 'tasks', 'todos'];
            let foundData = null;
            for (const key of keysToCheck) {
                const raw = localStorage.getItem(key);
                if (raw) { try { const parsed = JSON.parse(raw); if (Array.isArray(parsed) && parsed.length > 0) { foundData = parsed; break; } } catch(e) {} }
            }
            if (foundData) { if (!localStorage.getItem(MASTER_KEY)) localStorage.setItem(MASTER_KEY, JSON.stringify(foundData)); return foundData; }
            return [];
        }
        todos = attemptDataRecovery();

        function getWeekKey(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            var weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
            return d.getUTCFullYear() + "-W" + weekNo;
        }

        function getCycleKey(recurrence, date) {
            if (!date) date = new Date();
            const yyyy = date.getFullYear();
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            if (recurrence === 'daily' || recurrence === 'workdays') return `${yyyy}-${mm}-${dd}`;
            if (recurrence === 'weekly') return getWeekKey(date);
            if (recurrence === 'monthly') return `${yyyy}-${mm}`;
            if (recurrence === 'yearly') return `${yyyy}`;
            return null;
        }

        function checkRecurringReset() {
            const now = new Date();
            let changed = false;
            todos = todos.map(t => {
                if (!t.archived && !t.deleted && t.recurrence && t.recurrence !== 'none' && t.completed) {
                    const currentKey = getCycleKey(t.recurrence, now);
                    const lastKey = t.completionHistory && t.completionHistory.length > 0 ? t.completionHistory[t.completionHistory.length-1] : null;
                    if (lastKey !== currentKey) { changed = true; return { ...t, completed: false }; }
                }
                if (t.recurrence && t.recurrence !== 'none' && t.deadline) { changed = true; return { ...t, deadline: null }; }
                return t;
            });
            if(changed) { saveTodos(); renderTodos(); }
        }
        document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') { checkRecurringReset(); renderTodos(); } });
        checkRecurringReset();

        function saveConfig() { localStorage.setItem(CONFIG_KEY, JSON.stringify(config)); }
        window.saveTitle = function(newTitle) { config.title = newTitle.trim() || 'Tasks'; saveConfig(); }

        // --- VIEW MANAGEMENT (v68 Fix) ---
        window.toggleActivityView = function() {
            isActivityView = !isActivityView;
            if (isActivityView) {
                els.listView.style.display = 'none';
                els.activityView.classList.add('active');
                els.btnActivity.classList.add('active');
                els.toggleArchived.classList.remove('active'); // Ensure archive is not active
                showArchived = false; // Reset archived view
                els.viewContainer.classList.remove('view-archived');
                els.inputContainer.classList.add('input-hidden');
                
                renderHeatmap(currentHeatmapYear);
                renderChart(); // Init ECharts
            } else {
                els.listView.style.display = 'block';
                els.activityView.classList.remove('active');
                els.btnActivity.classList.remove('active');
                if (!showArchived) els.inputContainer.classList.remove('input-hidden');
            }
            renderTodos();
        };

        window.toggleShowArchived = function() {
            // v68 Fix: If in Activity view, switch back to list first
            if (isActivityView) {
                window.toggleActivityView();
            }

            showArchived = !showArchived;
            const btn = document.getElementById('toggleArchived');
            if (showArchived) {
                btn.classList.add('active');
                btn.title = "View Active";
                els.btnActivity.classList.remove('active'); // Ensure activity is not active
                isActivityView = false; // Reset activity view
                els.activityView.classList.remove('active');
                els.viewContainer.classList.add('view-archived');
                els.inputContainer.classList.add('input-hidden');
            } else {
                btn.classList.remove('active');
                btn.title = "View Archived";
                els.viewContainer.classList.remove('view-archived');
                els.inputContainer.classList.remove('input-hidden');
            }
            renderTodos();
        };

        // --- ECHARTS INTEGRATION (v68) ---
        function initChart() {
             if (myChart) myChart.dispose();
             myChart = echarts.init(els.activityChart);
             renderChart();
        }

        function getMonthlyData(year) {
            const counts = new Array(12).fill(0);
            todos.forEach(t => {
                if (!t.deleted) {
                    const dates = [...(t.completionHistory || [])];
                    if (t.completedAt && (t.completed || t.archived)) dates.push(t.completedAt);
                    dates.forEach(dStr => {
                        const date = new Date(dStr);
                        if (date.getFullYear() === year) counts[date.getMonth()]++;
                    });
                }
            });
            return counts;
        }

        function renderChart() {
            if (!isActivityView) return;
            if (!myChart) { initChart(); return; }

            const data = getMonthlyData(currentHeatmapYear);
            const style = getComputedStyle(document.documentElement);
            const colorAccent = style.getPropertyValue('--accent-blue').trim();
            const colorText = style.getPropertyValue('--text-secondary').trim();
            const colorGrid = style.getPropertyValue('--glass-border').trim();

            const option = {
                tooltip: { 
                    trigger: 'axis',
                    backgroundColor: style.getPropertyValue('--input-bg').trim(),
                    borderColor: colorGrid,
                    textStyle: { color: style.getPropertyValue('--text-primary').trim() }
                },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: {
                    type: 'category',
                    data: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    axisLine: { lineStyle: { color: colorText } },
                    axisTick: { show: false }
                },
                yAxis: {
                    type: 'value',
                    splitLine: { lineStyle: { color: colorGrid, type: 'dashed' } },
                    axisLine: { show: false },
                    axisLabel: { color: colorText }
                },
                series: [{
                    data: data,
                    type: chartType, // 'line' or 'bar'
                    smooth: true,
                    itemStyle: { color: colorAccent, borderRadius: [4, 4, 0, 0] },
                    lineStyle: { width: 3, color: colorAccent },
                    areaStyle: chartType === 'line' ? {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                          { offset: 0, color: colorAccent },
                          { offset: 1, color: 'rgba(0,0,0,0)' }
                        ]),
                        opacity: 0.2
                    } : null
                }]
            };
            myChart.setOption(option);
        }

        window.toggleChartType = function() {
            chartType = chartType === 'line' ? 'bar' : 'line';
            document.getElementById('chartLabel').innerText = chartType === 'line' ? 'Switch to Bar' : 'Switch to Line';
            const iconName = chartType === 'line' ? 'bar-chart-2' : 'activity';
            document.getElementById('chartIcon').setAttribute('data-lucide', iconName);
            lucide.createIcons();
            renderChart();
        }
        
        // Resize chart on window resize
        window.addEventListener('resize', () => { if(myChart) myChart.resize(); });


        // --- FULL YEAR CALENDAR ---
        window.openCalendarModal = function() {
            fullCalendarYear = currentHeatmapYear;
            renderFullYearCalendar();
            els.modalOverlay.classList.add('active');
            els.calendarModal.classList.add('open');
        }

        window.closeCalendarModal = function() {
            els.calendarModal.classList.remove('open');
            els.modalOverlay.classList.remove('active');
        }

        window.changeFullCalendarYear = function(delta) {
            fullCalendarYear += delta;
            renderFullYearCalendar();
        }

        function renderFullYearCalendar() {
            els.fullCalTitle.innerText = `${fullCalendarYear} Details`;
            const container = els.yearScrollContainer;
            container.innerHTML = '';

            const yearData = {}; 
            todos.forEach(t => {
                if (!t.deleted) {
                    const dates = [...(t.completionHistory || [])];
                    if (t.completedAt && (t.completed || t.archived)) dates.push(t.completedAt);
                    dates.forEach(dStr => {
                        const d = new Date(dStr);
                        if (d.getFullYear() === fullCalendarYear) {
                            const key = `${d.getMonth()}-${d.getDate()}`;
                            yearData[key] = (yearData[key] || 0) + 1;
                        }
                    });
                }
            });

            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            
            for (let m = 0; m < 12; m++) {
                const monthCard = document.createElement('div');
                monthCard.className = 'single-month-card';
                
                // Calculate monthly total
                let monthTotal = 0;
                Object.keys(yearData).forEach(key => {
                    const [month, day] = key.split('-').map(Number);
                    if (month === m) monthTotal += yearData[key];
                });
                
                const header = document.createElement('div');
                header.className = 'sm-header';
                header.innerText = `${monthNames[m]}  ${monthTotal}`;
                monthCard.appendChild(header);

                const grid = document.createElement('div');
                grid.className = 'sm-grid';

                const firstDay = new Date(fullCalendarYear, m, 1).getDay();
                const daysInMonth = new Date(fullCalendarYear, m + 1, 0).getDate();

                for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement('div'));
                
                for(let d=1; d<=daysInMonth; d++) {
                    const cell = document.createElement('div');
                    cell.className = 'sm-cell';
                    const key = `${m}-${d}`;
                    const count = yearData[key] || 0;
                    
                    if (count > 0) {
                        // v68: Removed Box Shadow, using Opacity/Color only
                        if (count >= 5) cell.classList.add('sm-l3'); 
                        else if (count >= 3) cell.classList.add('sm-l2'); 
                        else cell.classList.add('sm-l1'); 
                    }

                    const dateStr = new Date(fullCalendarYear, m, d).toLocaleDateString();
                    cell.addEventListener('mouseenter', (e) => showTooltip(e, dateStr, count));
                    cell.addEventListener('mousemove', moveTooltip);
                    cell.addEventListener('mouseleave', hideTooltip);

                    grid.appendChild(cell);
                }
                
                monthCard.appendChild(grid);
                container.appendChild(monthCard);
            }
        }

        // --- HEATMAP ---
        window.changeHeatmapYear = function(delta) {
            currentHeatmapYear += delta;
            renderHeatmap(currentHeatmapYear);
            renderChart();
        }

        function renderHeatmap(year) {
            if(els.heatmapYear) els.heatmapYear.innerText = year;
            const grid = els.heatmapGrid;
            grid.innerHTML = '';
            
            const counts = {};
            let totalAll = 0;
            todos.forEach(t => {
                if(!t.deleted) { 
                    const dates = [...(t.completionHistory || [])];
                    if (t.completedAt && (t.completed || t.archived)) dates.push(t.completedAt);
                    dates.forEach(dStr => {
                        const date = new Date(dStr);
                        if(date.getFullYear() === year) {
                            const dateKey = date.toISOString().split('T')[0];
                            if (!counts[dateKey]) counts[dateKey] = 0;
                            counts[dateKey]++;
                            totalAll++;
                        }
                    });
                }
            });
            document.getElementById('totalCompletedDisplay').innerText = `${totalAll} Completed`;

            const startDate = new Date(year, 0, 1);
            const endDate = new Date(year, 11, 31);
            const startDay = startDate.getDay(); 
            
            for(let i=0; i<startDay; i++) {
                const empty = document.createElement('div');
                empty.className = 'hm-cell';
                empty.style.opacity = '0';
                empty.style.pointerEvents = 'none';
                grid.appendChild(empty);
            }

            const loopDate = new Date(startDate);
            while (loopDate <= endDate) {
                const dateKey = loopDate.toISOString().split('T')[0];
                const count = counts[dateKey] || 0;
                let level = '';
                if (count >= 5) level = 'hm-l4'; else if (count >= 3) level = 'hm-l3'; else if (count >= 1) level = 'hm-l2'; else level = 'hm-l1'; 
                
                const cell = document.createElement('div');
                cell.className = 'hm-cell ' + level;
                if(count === 0) cell.style.background = 'var(--hm-bg)';
                
                cell.addEventListener('mouseenter', (e) => showTooltip(e, dateKey, count));
                cell.addEventListener('mousemove', (e) => moveTooltip(e));
                cell.addEventListener('mouseleave', hideTooltip);
                
                grid.appendChild(cell);
                loopDate.setDate(loopDate.getDate() + 1);
            }
        }
        
        function showTooltip(e, date, count) {
            const tt = els.globalTooltip;
            tt.innerHTML = `<strong>${date}</strong><br>${count} completed`;
            tt.classList.add('visible');
            moveTooltip(e);
        }
        function moveTooltip(e) {
            const tt = els.globalTooltip;
            const offset = 15;
            tt.style.top = (e.clientY + offset) + 'px';
            tt.style.left = (e.clientX + offset) + 'px';
        }
        function hideTooltip() { els.globalTooltip.classList.remove('visible'); }

        window.openThemePicker = function() {
            els.themeGrid.innerHTML = '';
            THEMES.forEach(t => {
                const option = document.createElement('div');
                option.className = `theme-card ${config.theme === t.id ? 'selected' : ''}`;
                option.onclick = () => window.selectTheme(t.id);
                option.innerHTML = `
                    <div class="preview-box" style="background:${t.bg}; color:${t.text}">
                        <div class="mini-header" style="background:${t.text}"></div>
                        <div class="mini-row" style="background:${t.text}"></div>
                        <div class="mini-row short" style="background:${t.text}"></div>
                        <div class="mini-fab" style="background:${t.acc}"></div>
                    </div>
                    <div class="theme-info">
                        <span class="theme-name">${t.name}</span>
                        ${config.theme === t.id ? '<div class="selected-icon"><i data-lucide="check"></i></div>' : ''}
                    </div>
                `;
                els.themeGrid.appendChild(option);
            });
            lucide.createIcons();
            els.modalOverlay.classList.add('active');
            els.themeModal.classList.add('open');
        }

        window.selectTheme = function(id) {
            config.theme = id;
            document.documentElement.setAttribute('data-theme', id);
            saveConfig();
            window.openThemePicker(); 
            if(isActivityView) setTimeout(renderChart, 100); // Re-render chart with new colors
        }

        window.closeThemePicker = function() { els.themeModal.classList.remove('open'); els.modalOverlay.classList.remove('active'); }
        window.openTrash = function() { renderTrash(); els.modalOverlay.classList.add('active'); els.trashModal.classList.add('open'); }
        window.closeTrash = function() { els.trashModal.classList.remove('open'); els.modalOverlay.classList.remove('active'); }
        
        function renderTrash() {
            const deleted = todos.filter(t => t.deleted);
            els.trashList.innerHTML = '';
            if(deleted.length === 0) { els.trashList.innerHTML = '<div style="text-align:center; opacity:0.5; padding:20px;">Trash is empty</div>'; return; }
            deleted.forEach(t => {
                const el = document.createElement('div'); el.className = 'todo-item deleted';
                el.innerHTML = `
                    <div class="todo-content"><div class="todo-text">${parseMarkdown(t.text)}</div></div>
                    <div class="item-actions" style="opacity:1;">
                         <button class="icon-btn unarchive" onclick="window.restoreTodo(${t.id})" title="Restore"><i data-lucide="undo-2"></i></button>
                         <button class="icon-btn delete" onclick="window.hardDelete(${t.id})" title="Delete Forever"><i data-lucide="x"></i></button>
                    </div>`;
                els.trashList.appendChild(el);
            });
            lucide.createIcons();
        }
        
        window.restoreTodo = function(id) { todos = todos.map(t => t.id === id ? {...t, deleted: false} : t); saveTodos(); renderTrash(); renderTodos(); if(isActivityView) { renderHeatmap(currentHeatmapYear); renderChart(); } }
        window.hardDelete = function(id) { todos = todos.filter(t => t.id !== id); saveTodos(); renderTrash(); if(isActivityView) { renderHeatmap(currentHeatmapYear); renderChart(); } }
        window.emptyTrash = function() { if(confirm('Delete all items?')) { todos = todos.filter(t => !t.deleted); saveTodos(); renderTrash(); if(isActivityView) { renderHeatmap(currentHeatmapYear); renderChart(); } } }

        function parseMarkdown(text) {
            if(!text) return '';
            let html = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
                .split('\n').map(line => {
                    if (line.trim().startsWith('- ')) return `<ul><li>${line.trim().substring(2)}</li></ul>`;
                    if (line.trim().startsWith('## ')) return `<div style="font-weight:700; opacity:0.9;">${line.trim().substring(3)}</div>`;
                    if (line.trim().startsWith('> ')) return `<blockquote>${line.trim().substring(2)}</blockquote>`;
                    return line;
                }).join('<br>');
            return html.replace(/`(.*?)`/g, '<code>$1</code>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/<br><ul>/g, '<ul>').replace(/<\/ul><br>/g, '</ul>');
        }

        window.insertMarkdown = function(startTag, endTag) {
            const input = els.todoInput;
            const start = input.selectionStart; const end = input.selectionEnd; const text = input.value;
            input.value = text.substring(0, start) + startTag + text.substring(start, end) + endTag + text.substring(end);
            input.focus(); input.selectionStart = start + startTag.length; input.selectionEnd = start + startTag.length + (end - start);
            if(!isExpanded) input.dispatchEvent(new Event('input'));
        }

        window.toggleTaskDatePicker = function() { els.taskDatePicker.classList.toggle('open'); if(els.taskDatePicker.classList.contains('open')) { pickerCurrentDate = newTaskDate ? new Date(newTaskDate) : new Date(); renderTaskDatePicker(); } }
        window.changeTaskMonth = function(d) { pickerCurrentDate.setMonth(pickerCurrentDate.getMonth() + d); renderTaskDatePicker(); }

        function renderTaskDatePicker() {
            const y = pickerCurrentDate.getFullYear(), m = pickerCurrentDate.getMonth(), today = new Date();
            els.dpTitle.innerText = pickerCurrentDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            els.dpGrid.innerHTML = '';
            const first = new Date(y, m, 1).getDay(), days = new Date(y, m+1, 0).getDate();
            for(let i=0; i<first; i++) els.dpGrid.appendChild(document.createElement('div'));
            for(let d=1; d<=days; d++) {
                const el = document.createElement('div'); el.className = 'dp-cell'; el.innerText = d;
                if (newTaskDate) { const sel = new Date(newTaskDate); if (sel.getFullYear() === y && sel.getMonth() === m && sel.getDate() === d) el.classList.add('selected'); }
                if (y === today.getFullYear() && m === today.getMonth() && d === today.getDate()) el.classList.add('is-today');
                el.onclick = () => { newTaskDate = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; els.taskDateDisplay.innerText = new Date(y,m,d).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }); els.taskDateTrigger.classList.add('active'); window.setRecurrence('none'); els.taskDatePicker.classList.remove('open'); };
                els.dpGrid.appendChild(el);
            }
        }

        window.cycleRecurrence = function() {
            const modes = ['none', 'daily', 'workdays', 'weekly', 'monthly', 'yearly'];
            let idx = modes.indexOf(newRecurrence);
            window.setRecurrence(modes[(idx + 1) % modes.length]);
        }

        window.setRecurrence = function(type) {
            newRecurrence = type;
            const labels = { 'none': 'Repeat', 'daily': 'Daily', 'workdays': 'Workdays', 'weekly': 'Weekly', 'monthly': 'Monthly', 'yearly': 'Yearly' };
            els.taskRecurDisplay.innerText = labels[type];
            if(type !== 'none') { els.taskRecurTrigger.classList.add('active'); newTaskDate = null; els.taskDateDisplay.innerText = "Due"; els.taskDateTrigger.classList.remove('active'); } else { els.taskRecurTrigger.classList.remove('active'); }
            document.querySelectorAll('.recur-btn').forEach(btn => btn.classList.remove('active'));
            if(type !== 'none') document.getElementById('recur' + type.charAt(0).toUpperCase() + type.slice(1)).classList.add('active');
            else document.getElementById('recurNone').classList.add('active');
        }

        window.toggleExpand = function() {
            isExpanded = !isExpanded;
            if(isExpanded) { els.inputContainer.classList.add('expanded'); els.modalOverlay.classList.add('active'); els.expandBtn.innerHTML = '<i data-lucide="minimize-2"></i>'; els.todoInput.focus(); }
            else { 
                els.inputContainer.classList.remove('expanded'); els.modalOverlay.classList.remove('active'); els.expandBtn.innerHTML = '<i data-lucide="maximize-2"></i>'; els.todoInput.style.cssText = ''; 
                if (editingTaskId) { editingTaskId = null; els.todoInput.value = ''; newTaskDate = null; window.setRecurrence('none'); els.taskDateDisplay.innerText = "Due"; els.taskDateTrigger.classList.remove('active'); els.actionBtn.classList.remove('save-mode'); els.actionIcon.setAttribute('data-lucide', 'arrow-up'); }
                els.taskDatePicker.classList.remove('open');
            }
            lucide.createIcons();
        }

        window.closeOverlays = function() { if(isExpanded) window.toggleExpand(); if(els.detailModal.classList.contains('open')) window.closeDetail(); if(els.themeModal.classList.contains('open')) window.closeThemePicker(); if(els.trashModal.classList.contains('open')) window.closeTrash(); if(els.calendarModal.classList.contains('open')) window.closeCalendarModal(); }

        window.addTodo = function() {
            if(!els.todoInput.value.trim()) return;
            if (editingTaskId) {
                todos = todos.map(t => t.id === editingTaskId ? { ...t, text: els.todoInput.value.trim(), deadline: newTaskDate, recurrence: newRecurrence } : t);
            } else {
                todos.unshift({ id: Date.now(), text: els.todoInput.value.trim(), completed: false, archived: false, deleted: false, pinned: false, deadline: newTaskDate, recurrence: newRecurrence, completionHistory: [] });
            }
            saveTodos(); els.todoInput.value = ''; window.setRecurrence('none'); if(isExpanded) window.toggleExpand(); newTaskDate = null; els.taskDateDisplay.innerText = "Due"; els.taskDateTrigger.classList.remove('active'); renderTodos();
        };

        window.openEditSheet = function(id) {
            window.closeDetail(); const todo = todos.find(t => t.id === id); if (!todo) return;
            editingTaskId = id; els.todoInput.value = todo.text; window.setRecurrence(todo.recurrence || 'none'); 
            if (todo.deadline) { newTaskDate = todo.deadline; const d = new Date(newTaskDate); els.taskDateDisplay.innerText = d.toLocaleDateString('en-US', { weekday:'short', month:'short', day:'numeric' }); els.taskDateTrigger.classList.add('active'); }
            else { newTaskDate = null; els.taskDateDisplay.innerText = "Due"; els.taskDateTrigger.classList.remove('active'); }
            els.actionBtn.classList.add('save-mode'); els.actionIcon.setAttribute('data-lucide', 'check'); lucide.createIcons();
            if (!isExpanded) window.toggleExpand(); else els.todoInput.focus();
        }

        window.togglePin = function(id) { todos = todos.map(t => t.id === id ? {...t, pinned: !t.pinned} : t); saveTodos(); renderTodos(); }

        window.toggleTodo = function(id) { 
            const todo = todos.find(t => t.id === id); if (!todo) return;
            if (todo.recurrence && todo.recurrence !== 'none') {
                const isNowCompleted = !todo.completed; const now = new Date(); const cycleKey = getCycleKey(todo.recurrence, now);
                let newHistory = todo.completionHistory || []; const lastKey = newHistory.length > 0 ? newHistory[newHistory.length-1] : null;
                if (isNowCompleted && lastKey !== cycleKey) { newHistory.push(cycleKey); todos.push({ id: Date.now(), text: todo.text, completed: true, archived: true, deleted: false, completedAt: now.toISOString(), deadline: null, recurrence: todo.recurrence }); }
                todos = todos.map(t => t.id === id ? { ...t, completed: isNowCompleted, completionHistory: newHistory } : t);
                saveTodos(); renderTodos(); if(isNowCompleted && showArchived) { renderHeatmap(currentHeatmapYear); renderChart(); }
            } else {
                const newStatus = !todo.completed; const update = { completed: newStatus, completedAt: newStatus ? new Date().toISOString() : undefined };
                todos = todos.map(t => t.id === id ? {...t, ...update} : t); saveTodos();
                if (newStatus) { const itemEl = document.getElementById(`todo-${id}`); if (itemEl) { itemEl.classList.add('completed'); setTimeout(() => { if(itemEl) itemEl.classList.add('slide-out-right'); }, 400); setTimeout(() => { todos = todos.map(t => t.id === id ? {...t, archived: true} : t); saveTodos(); renderTodos(); if(showArchived) { renderHeatmap(currentHeatmapYear); renderChart(); } }, 800); } else renderTodos(); } else renderTodos();
            }
        };
        
        window.deleteTodo = function(id) { const el = document.getElementById(`todo-${id}`); if(el) el.classList.add('slide-out-left'); setTimeout(() => { todos = todos.map(t => t.id === id ? {...t, deleted: true} : t); saveTodos(); renderTodos(); if(isActivityView) { renderHeatmap(currentHeatmapYear); renderChart(); } }, 350); }
        window.unarchiveTodo = function(id) { todos = todos.map(t => t.id === id ? {...t, archived: false, completed: false} : t); saveTodos(); renderTodos(); }

        window.openDetail = function(id) {
            const todo = todos.find(t => t.id === id); if(!todo) return;
            currentDetailId = id; els.detailContent.innerHTML = `<div class="detail-text">${parseMarkdown(todo.text)}</div>`;
            let metaText = "Created " + new Date(todo.id).toLocaleDateString();
            if(todo.deadline) metaText += `  Due ${todo.deadline}`;
            if(todo.recurrence && todo.recurrence !== 'none') metaText += `  Repeats ${todo.recurrence}`;
            const isReadOnly = (showArchived || todo.archived);
            let actionButtons = '';
            if (!isReadOnly) {
                actionButtons += `<button class="detail-icon-btn edit" onclick="window.openEditSheet(${todo.id})" title="Edit"><i data-lucide="pencil"></i></button>`;
                actionButtons += `<button class="detail-icon-btn pin" onclick="window.togglePin(${todo.id}); window.closeDetail();" title="${todo.pinned ? 'Unpin' : 'Pin'}"><i data-lucide="${todo.pinned ? 'pin-off' : 'pin'}"></i></button>`;
            }
            if (isReadOnly) actionButtons += `<button class="detail-icon-btn unarchive" onclick="window.unarchiveTodo(${todo.id}); window.closeDetail();" title="Restore"><i data-lucide="undo-2"></i></button>`;
            else actionButtons += `<button class="detail-icon-btn archive" onclick="window.toggleTodo(${todo.id}); window.closeDetail();" title="Archive"><i data-lucide="archive"></i></button>`;
            actionButtons += `<button class="detail-icon-btn delete" onclick="window.deleteTodo(${todo.id}); window.closeDetail();" title="Delete"><i data-lucide="trash-2"></i></button>`;
            actionButtons += `<button class="detail-icon-btn close" onclick="window.closeDetail()" title="Close"><i data-lucide="x"></i></button>`;
            els.detailMeta.innerText = metaText; els.detailActions.innerHTML = actionButtons;
            els.modalOverlay.classList.add('active'); els.detailModal.classList.add('open'); lucide.createIcons();
        }
        
        window.closeDetail = function() { els.detailModal.classList.remove('open'); if (!isExpanded) els.modalOverlay.classList.remove('active'); currentDetailId = null; }

        function createTodoElement(todo) {
            let deadlineHtml = '';
            if(!showArchived && todo.recurrence && todo.recurrence !== 'none') {
                 if (todo.completed) { const resetLabel = { 'daily': 'Tomorrow', 'weekly': 'Next Week', 'workdays': 'Next Workday', 'monthly': 'Next Month', 'yearly': 'Next Year' }[todo.recurrence] || 'Next Cycle'; deadlineHtml = `<div class="deadline-badge reset-prompt"> Resets ${resetLabel}</div>`; }
                 else { deadlineHtml = `<div class="deadline-badge repeat"> ${todo.recurrence}</div>`; }
            } else if (todo.deadline) {
                const d = new Date(todo.deadline); const diffDays = Math.ceil((d - new Date().setHours(0,0,0,0)) / (86400000));
                let pClass = diffDays <= 0 ? "p-critical" : (diffDays === 1 ? "p-high" : (diffDays <= 3 ? "p-high" : (diffDays <= 7 ? "p-medium" : "")));
                deadlineHtml = `<div class="deadline-badge ${pClass}"><i data-lucide="clock" style="width:10px;"></i> ${d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}  ${diffDays <= 0 ? (diffDays<0?"Overdue":"Today") : diffDays + "d left"}</div>`;
            }
            if (showArchived && todo.completedAt) {
                 const d = new Date(todo.completedAt); const dateStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                 if (todo.recurrence && todo.recurrence !== 'none') deadlineHtml = `<div class="deadline-badge" style="color:var(--text-secondary); border-color:var(--glass-border);"><i data-lucide="rotate-cw" style="width:10px; margin-right:4px;"></i> Done ${dateStr}</div>`;
                 else deadlineHtml = `<div class="deadline-badge" style="color:var(--text-secondary); border-color:var(--glass-border);"><i data-lucide="check" style="width:10px; margin-right:4px;"></i> Done ${dateStr}</div>`;
            }

            const el = document.createElement('div');
            const isRecurringDone = (!showArchived && todo.recurrence && todo.recurrence !== 'none' && todo.completed);
            el.className = `todo-item ${todo.completed ? 'completed' : ''} ${isRecurringDone ? 'recurring-done' : ''} ${todo.pinned ? 'pinned' : ''}`;
            el.id = `todo-${todo.id}`;
            const isReadOnly = (showArchived || todo.archived);

            let actionButtons = '';
            if (!isReadOnly) {
                actionButtons += `<button class="icon-btn edit" onclick="window.openEditSheet(${todo.id})" title="Edit"><i data-lucide="pencil"></i></button>`;
                actionButtons += `<button class="icon-btn pin" onclick="window.togglePin(${todo.id})" title="${todo.pinned ? 'Unpin' : 'Pin'}"><i data-lucide="${todo.pinned ? 'pin-off' : 'pin'}"></i></button>`;
                actionButtons += `<button class="icon-btn archive" onclick="window.toggleTodo(${todo.id})" title="Archive"><i data-lucide="archive"></i></button>`;
            } else {
                actionButtons += `<button class="icon-btn unarchive" onclick="window.unarchiveTodo(${todo.id})" title="Restore"><i data-lucide="undo-2"></i></button>`;
            }
            actionButtons += `<button class="icon-btn delete" onclick="window.deleteTodo(${todo.id})" title="Delete"><i data-lucide="trash-2"></i></button>`;

            el.innerHTML = `
                <div class="custom-checkbox" onclick="event.stopPropagation(); window.toggleTodo(${todo.id})"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                <div class="todo-content" onclick="window.openDetail(${todo.id})">
                    <div class="todo-text" data-tooltip="${todo.text.replace(/"/g, '&quot;')}">${parseMarkdown(todo.text)}</div>
                    ${deadlineHtml ? `<div class="todo-meta">${deadlineHtml}</div>` : ''}
                </div>
                <div class="item-actions">${actionButtons}</div>`;
            return el;
        }

        function renderTodos() {
            const allTodos = todos.filter(t => !t.deleted && (showArchived ? t.archived : !t.archived) && t.text.toLowerCase().includes(searchTerm.toLowerCase()));
            const pinnedTasks = allTodos.filter(t => t.pinned && !showArchived);
            const normalTasks = allTodos.filter(t => !t.pinned || showArchived);

            const sortFn = (a, b) => {
                if (!showArchived) {
                    const aR = (a.recurrence && a.recurrence !== 'none'), bR = (b.recurrence && b.recurrence !== 'none');
                    if (aR && !bR) return -1; if (!aR && bR) return 1; if (aR && bR) return b.id - a.id;
                }
                if (a.completed !== b.completed) return a.completed - b.completed;
                if (!a.completed) {
                    if (a.deadline && b.deadline) return new Date(a.deadline) - new Date(b.deadline);
                    if (a.deadline && !b.deadline) return -1; if (!a.deadline && b.deadline) return 1;
                }
                return a.id - b.id;
            };

            pinnedTasks.sort(sortFn); normalTasks.sort(sortFn);
            els.pinnedList.innerHTML = '';
            if (pinnedTasks.length > 0) { els.pinnedContainer.classList.add('active'); pinnedTasks.forEach(t => els.pinnedList.appendChild(createTodoElement(t))); } else { els.pinnedContainer.classList.remove('active'); }
            els.todoList.innerHTML = '';
            els.emptyTodo.style.display = (normalTasks.length === 0 && pinnedTasks.length === 0) ? 'flex' : 'none';
            els.emptyTodoText.innerText = showArchived ? 'No archived tasks.' : 'All caught up.';
            normalTasks.forEach(t => els.todoList.appendChild(createTodoElement(t)));
            lucide.createIcons();
        }

        function init() {
            document.getElementById('dateDisplay').innerText = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
            renderTodos();
            document.addEventListener('click', (e) => { if (!els.taskDatePicker.contains(e.target) && !els.taskDateTrigger.contains(e.target)) els.taskDatePicker.classList.remove('open'); });
            els.todoInput.addEventListener('input', function() { if(!isExpanded) { this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px'; } });
            els.todoInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey && !isExpanded) { e.preventDefault(); window.addTodo(); } });
            els.searchInput.addEventListener('input', (e) => { searchTerm = e.target.value.trim(); renderTodos(); });
        }
        init();

    </script>
</body>
</html>